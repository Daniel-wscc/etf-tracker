{
  "name": "My workflow",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 9
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -608,
        96
      ],
      "id": "1818d41e-e222-4890-bc2f-d84f7fbab611",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "etf_data"
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -48,
        96
      ],
      "id": "44cfbc08-6916-4873-aa0c-ed0883b67879",
      "name": "Get many rows",
      "executeOnce": true,
      "retryOnFail": false,
      "credentials": {
        "supabaseApi": {
          "id": "HxuTzeHf02uarRR1",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "fromEmail": "ogame033641685@gmail.com",
        "toEmail": "ogame033641685@gmail.com",
        "subject": "=ETF æŠ•è³‡çµ„åˆæ¯æ—¥å ±å‘Š - {{ $('Process ETF Data').first().json.reportDate }}",
        "html": "=<h2>ğŸ“Š ETF æŠ•è³‡çµ„åˆæ¯æ—¥å ±å‘Š</h2>\n<p><strong>å ±å‘Šæ—¥æœŸï¼š</strong>{{ $('Process ETF Data').first().json.reportDate }}</p>\n\n<h3>ğŸ“ˆ æŠ•è³‡çµ„åˆæ¦‚è¦½</h3>\n<table border='1' style='border-collapse: collapse; width: 100%;'>\n  <tr style='background-color: #f2f2f2;'>\n    <th style='padding: 8px;'>ä»£ç¢¼</th>\n    <th style='padding: 8px;'>åç¨±</th>\n    <th style='padding: 8px;'>æŒè‚¡æ•¸é‡</th>\n    <th style='padding: 8px;'>è²·é€²å–®åƒ¹</th>\n    <th style='padding: 8px;'>ç¸½æŠ•è³‡æˆæœ¬</th>\n    <th style='padding: 8px;'>ç•¶å‰åƒ¹æ ¼</th>\n    <th style='padding: 8px;'>ç•¶å‰ç¸½åƒ¹å€¼</th>\n    <th style='padding: 8px;'>æç›Š</th>\n    <th style='padding: 8px;'>æ”¶ç›Šç‡</th>\n    <th style='padding: 8px;'>ç‹€æ…‹</th>\n    <th style='padding: 8px;'>æ•¸æ“šä¾†æº</th>\n  </tr>\n  {{ $('Process ETF Data').all().map(item => `\n  <tr style='background-color: ${item.json.hasError ? '#ffe6e6' : 'white'};'>\n    <td style='padding: 8px;'>${item.json.symbol}</td>\n    <td style='padding: 8px;'>${item.json.stockName || item.json.symbol}</td>\n    <td style='padding: 8px;'>${item.json.shares}</td>\n    <td style='padding: 8px;'>$${item.json.unitCost.toFixed(2)} TWD</td>\n    <td style='padding: 8px;'>$${Math.round(item.json.cost)} TWD</td>\n    <td style='padding: 8px; color: ${item.json.hasError ? 'red' : 'black'};'>${item.json.hasError ? 'N/A' : '$' + item.json.currentPrice.toFixed(2) + ' TWD' + (item.json.currency === 'USD' ? '<br><small style=\"color: #666;\">($' + item.json.originalPrice.toFixed(2) + ' USD)</small>' : '')}</td>\n    <td style='padding: 8px; color: ${item.json.hasError ? 'red' : 'black'};'>${item.json.hasError ? 'N/A' : '$' + Math.round(item.json.totalValue) + ' TWD'}</td>\n    <td style='padding: 8px; color: ${item.json.hasError ? 'red' : (item.json.profit >= 0 ? 'green' : 'red')};'>${item.json.hasError ? 'N/A' : '$' + Math.round(item.json.profit) + ' TWD'}</td>\n    <td style='padding: 8px; color: ${item.json.hasError ? 'red' : (item.json.profitPercentage >= 0 ? 'green' : 'red')};'>${item.json.hasError ? 'N/A' : item.json.profitPercentage.toFixed(2) + '%'}</td>\n    <td style='padding: 8px; color: ${item.json.hasError ? 'red' : (item.json.profit >= 0 ? 'green' : 'red')};'>${item.json.hasError ? 'éŒ¯èª¤' : item.json.profitStatus}</td>\n    <td style='padding: 8px; font-size: 10px;'>${item.json.apiSource}${item.json.currency === 'USD' ? '<br>åŒ¯ç‡: ' + item.json.exchangeRate : ''}</td>\n  </tr>\n  `).join('') }}\n</table>\n\n<h3>ğŸ’° ç¸½è¨ˆçµ±è¨ˆ</h3>\n<p><strong>ç¸½æŠ•è³‡æˆæœ¬ï¼š</strong>${{ Math.round($('Process ETF Data').all().reduce((sum, item) => sum + (item.json.cost || 0), 0)) }} TWD</p>\n<p><strong>ç¸½ç•¶å‰åƒ¹å€¼ï¼š</strong>${{ Math.round($('Process ETF Data').all().filter(item => !item.json.hasError).reduce((sum, item) => sum + (item.json.totalValue || 0), 0)) }} TWD <span style='color: red; font-size: 12px;'>(æ’é™¤éŒ¯èª¤é …ç›®)</span></p>\n<p><strong>ç¸½æç›Šï¼š</strong><span style='color: {{ $('Process ETF Data').all().filter(item => !item.json.hasError).reduce((sum, item) => sum + (item.json.profit || 0), 0) >= 0 ? 'green' : 'red' }};'>${{ Math.round($('Process ETF Data').all().filter(item => !item.json.hasError).reduce((sum, item) => sum + (item.json.profit || 0), 0)) }} TWD</span> <span style='color: red; font-size: 12px;'>(æ’é™¤éŒ¯èª¤é …ç›®)</span></p>\n<p><strong>ç¸½æ”¶ç›Šç‡ï¼š</strong><span style='color: {{ ($('Process ETF Data').all().filter(item => !item.json.hasError).reduce((sum, item) => sum + (item.json.profit || 0), 0) / Math.max($('Process ETF Data').all().reduce((sum, item) => sum + (item.json.cost || 0), 0), 1) * 100) >= 0 ? 'green' : 'red' }};'>{{ ($('Process ETF Data').all().filter(item => !item.json.hasError).reduce((sum, item) => sum + (item.json.profit || 0), 0) / Math.max($('Process ETF Data').all().reduce((sum, item) => sum + (item.json.cost || 0), 0), 1) * 100).toFixed(2) }}%</span> <span style='color: red; font-size: 12px;'>(æ’é™¤éŒ¯èª¤é …ç›®)</span></p>\n\n<h3>ğŸ’± åŒ¯ç‡è³‡è¨Š</h3>\n<p><strong>ä½¿ç”¨åŒ¯ç‡ï¼š</strong>USD/TWD = {{ $('Get Exchange Rate').first().json.rates.TWD || 'N/A' }}</p>\n<p><strong>åŒ¯ç‡æ›´æ–°æ™‚é–“ï¼š</strong>{{ $('Get Exchange Rate').first().json.date ? new Date($('Get Exchange Rate').first().json.date).toLocaleString('zh-TW') : 'N/A' }}</p>\n<p><strong>èªªæ˜ï¼š</strong>ç¾è‚¡ETFåƒ¹æ ¼å·²è‡ªå‹•è½‰æ›ç‚ºå°å¹£é¡¯ç¤ºï¼Œæ‰€æœ‰è¨ˆç®—å‡ä»¥å°å¹£ç‚ºåŸºæº–ã€‚åŒ¯ç‡æ•¸æ“šä¾†è‡ª ExchangeRate-APIã€‚</p>\n\n<h3>âš ï¸ éŒ¯èª¤é …ç›®</h3>\n{{ $('Process ETF Data').all().filter(item => item.json.hasError).length > 0 ? `<p style='color: red;'>æœ‰ ${$('Process ETF Data').all().filter(item => item.json.hasError).length} å€‹é …ç›®ç„¡æ³•ç²å–åƒ¹æ ¼æ•¸æ“šï¼Œè«‹æª¢æŸ¥è‚¡ç¥¨ä»£ç¢¼æ ¼å¼ã€‚</p>` : `<p style='color: green;'>âœ… æ‰€æœ‰é …ç›®éƒ½æˆåŠŸç²å–åƒ¹æ ¼æ•¸æ“š</p>` }}\n\n<p style='margin-top: 20px; font-size: 12px; color: #666;'>æ­¤å ±å‘Šç”± n8n è‡ªå‹•ç”Ÿæˆï¼Œæ•¸æ“šä¾†æºæ–¼ Yahoo Finance APIï¼ŒåŒ¯ç‡è½‰æ›å·²è‡ªå‹•è™•ç†ã€‚</p>",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        528,
        96
      ],
      "id": "700d8667-49a3-4162-94ab-a1dcb8f86683",
      "name": "Send ETF Report",
      "webhookId": "060433d2-75e4-471b-87f8-867f3c314a18",
      "executeOnce": true,
      "alwaysOutputData": false,
      "credentials": {
        "smtp": {
          "id": "vpxYVWEMehSyMV4j",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://query1.finance.yahoo.com/v8/finance/chart/{{ $json.symbol }}",
        "options": {
          "timeout": 10000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        144,
        96
      ],
      "id": "4366bf70-370c-40ec-b279-6dade695553f",
      "name": "Get ETF Price (Yahoo Finance)",
      "executeOnce": false,
      "continueOnFail": true
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// æ™ºèƒ½è™•ç†å–®å€‹ ETF æ•¸æ“šä¸¦è¨ˆç®—æ”¶ç›Š (Run Once for Each Item æ¨¡å¼)\n\n// è‚¡ç¥¨ä»£ç¢¼æ ¼å¼è½‰æ›å‡½æ•¸\nfunction formatSymbolForYahoo(symbol) {\n  // æª¢æŸ¥ symbol æ˜¯å¦å­˜åœ¨ä¸”ç‚ºå­—ç¬¦ä¸²\n  if (!symbol || typeof symbol !== 'string') {\n    return 'UNKNOWN';\n  }\n  \n  // ç§»é™¤ .TW å¾Œç¶´\n  let formattedSymbol = symbol.replace(/\\.TW$/i, '');\n  \n  // å°è‚¡ ETF éœ€è¦æ·»åŠ  .TW å¾Œç¶´\n  if (/^\\d{4,5}$/.test(formattedSymbol)) {\n    return formattedSymbol + '.TW';\n  }\n  \n  // ç¾è‚¡å’Œå…¶ä»–åœ‹éš›è‚¡ç¥¨ä¿æŒåŸæ¨£\n  return formattedSymbol;\n}\n\n// å®‰å…¨ç²å–æ•¸å€¼çš„å‡½æ•¸\nfunction safeParseFloat(value, defaultValue = 0) {\n  if (value === null || value === undefined || value === '') {\n    return defaultValue;\n  }\n  const parsed = parseFloat(value);\n  return isNaN(parsed) ? defaultValue : parsed;\n}\n\n// åˆ¤æ–·æ˜¯å¦ç‚ºå°ç£è‚¡ç¥¨\nfunction isTaiwanStock(symbol) {\n  if (!symbol || typeof symbol !== 'string') return false;\n  return symbol.toLowerCase().includes('.tw') || \n         /^\\d{4}$/.test(symbol) || \n         /^\\d{5}$/.test(symbol);\n}\n\n// ç²å–åŒ¯ç‡ (å¾ ExchangeRate-API ç²å–æœ€æ–°åŒ¯ç‡)\nfunction getExchangeRate() {\n  try {\n    // å¾ Get Exchange Rate ç¯€é»ç²å–æœ€æ–°åŒ¯ç‡\n    const exchangeRateData = $('Get Exchange Rate').first().json;\n    if (exchangeRateData && exchangeRateData.rates && exchangeRateData.rates.TWD) {\n      return parseFloat(exchangeRateData.rates.TWD);\n    }\n  } catch (error) {\n    console.warn('ç„¡æ³•ç²å–åŒ¯ç‡æ•¸æ“šï¼Œä½¿ç”¨é è¨­å€¼:', error);\n  }\n  \n  // å¦‚æœç„¡æ³•ç²å–åŒ¯ç‡ï¼Œä½¿ç”¨é è¨­å€¼\n  return 31.5;\n}\n\ntry {\n  // åœ¨ Run Once for Each Item æ¨¡å¼ä¸‹ï¼Œå¾ Get many rows ç¯€é»ç²å–åŸå§‹ ETF æ•¸æ“š\n  const etfData = $('Get many rows').item.json;\n  \n  // é©—è­‰å¿…è¦æ¬„ä½\n  if (!etfData) {\n    return {\n      json: {\n        symbol: 'UNKNOWN',\n        formattedSymbol: 'UNKNOWN',\n        stockName: 'æ•¸æ“šéŒ¯èª¤',\n        shares: 0,\n        cost: 0,\n        currentPrice: 0,\n        totalValue: 0,\n        profit: 0,\n        profitPercentage: 0,\n        profitStatus: 'éŒ¯èª¤',\n        apiSource: 'æ•¸æ“šé©—è­‰å¤±æ•—',\n        errorMessage: 'ETF æ•¸æ“šç‚ºç©ºæˆ–ç„¡æ•ˆ',\n        hasError: true,\n        lastUpdated: new Date().toLocaleString('zh-TW')\n      }\n    };\n  }\n  \n  // å¾ä¸Šä¸€å€‹ç¯€é»ç²å–åƒ¹æ ¼æ•¸æ“š - åœ¨ Run Once for Each Item æ¨¡å¼ä¸‹ä½¿ç”¨ .item.json\n  const priceData = $('Get ETF Price (Yahoo Finance)').item.json;\n  \n  // å¾ Yahoo Finance API è§£æåƒ¹æ ¼\n  let currentPrice = 0;\n  let originalPrice = 0; // åŸå§‹åƒ¹æ ¼ï¼ˆç¾å…ƒï¼‰\n  let stockName = etfData.symbol || 'UNKNOWN';\n  let apiSource = 'Yahoo Finance';\n  let errorMessage = '';\n  let currency = 'TWD'; // é è¨­ç‚ºå°å¹£\n  \n  // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤\n  if (priceData && priceData.chart && priceData.chart.error) {\n    errorMessage = `API éŒ¯èª¤: ${priceData.chart.error.description || 'æœªçŸ¥éŒ¯èª¤'}`;\n    apiSource = 'Yahoo Finance (éŒ¯èª¤)';\n  } else if (priceData && priceData.chart && priceData.chart.result && priceData.chart.result.length > 0) {\n    const result = priceData.chart.result[0];\n    const meta = result.meta;\n    originalPrice = meta.regularMarketPrice || meta.previousClose || 0;\n    stockName = meta.longName || meta.shortName || etfData.symbol || 'UNKNOWN';\n    currency = meta.currency || 'USD';\n    \n    // åˆ¤æ–·æ˜¯å¦ç‚ºå°è‚¡ï¼Œå¦‚æœä¸æ˜¯å°è‚¡å‰‡éœ€è¦åŒ¯ç‡è½‰æ›\n    const isTaiwan = isTaiwanStock(etfData.symbol);\n    if (isTaiwan) {\n      // å°è‚¡ç›´æ¥ä½¿ç”¨åŸåƒ¹æ ¼ï¼ˆå·²ç¶“æ˜¯å°å¹£ï¼‰\n      currentPrice = originalPrice;\n      currency = 'TWD';\n    } else {\n      // ç¾è‚¡éœ€è¦è½‰æ›ç‚ºå°å¹£\n      const exchangeRate = getExchangeRate();\n      currentPrice = originalPrice * exchangeRate;\n      currency = 'USD';\n    }\n    \n    // å¦‚æœåƒ¹æ ¼ç‚º 0ï¼Œå¯èƒ½æ˜¯æ•¸æ“šå•é¡Œ\n    if (currentPrice === 0) {\n      errorMessage = 'ç„¡æ³•ç²å–æœ‰æ•ˆåƒ¹æ ¼æ•¸æ“š';\n    }\n  } else {\n    errorMessage = 'API è¿”å›ç©ºæ•¸æ“šæˆ–ç„¡æ•ˆéŸ¿æ‡‰';\n    apiSource = 'Yahoo Finance (ç„¡æ•¸æ“š)';\n  }\n  \n  // å®‰å…¨è¨ˆç®—æ”¶ç›Š\n  const unitCost = safeParseFloat(etfData.cost, 0); // å–®åƒ¹ï¼ˆä¿æŒç²¾ç¢ºåº¦ï¼‰\n  const shares = safeParseFloat(etfData.shares, 0); // æŒè‚¡æ•¸é‡\n  const totalCost = unitCost * shares; // ç¸½æŠ•è³‡æˆæœ¬ï¼ˆç²¾ç¢ºè¨ˆç®—ï¼‰\n  const totalValue = currentPrice * shares; // ç•¶å‰ç¸½åƒ¹å€¼ï¼ˆç²¾ç¢ºè¨ˆç®—ï¼‰\n  const profit = totalValue - totalCost; // æç›Šï¼ˆç²¾ç¢ºè¨ˆç®—ï¼‰\n  const profitPercentage = totalCost > 0 ? ((totalValue - totalCost) / totalCost) * 100 : 0; // æ”¶ç›Šç‡ï¼ˆç²¾ç¢ºè¨ˆç®—ï¼‰\n  \n  // æ ¼å¼åŒ–æ•¸æ“š\n  const processedData = {\n    symbol: etfData.symbol || 'UNKNOWN',\n    formattedSymbol: formatSymbolForYahoo(etfData.symbol),\n    stockName: stockName,\n    shares: shares,\n    unitCost: unitCost, // å–®åƒ¹ï¼ˆå°å¹£ï¼‰\n    cost: totalCost, // ç¸½æŠ•è³‡æˆæœ¬ï¼ˆå°å¹£ï¼‰\n    currentPrice: currentPrice, // ç•¶å‰åƒ¹æ ¼ï¼ˆå°å¹£ï¼‰\n    originalPrice: originalPrice, // åŸå§‹åƒ¹æ ¼ï¼ˆç¾å…ƒï¼Œå¦‚æœæ˜¯ç¾è‚¡ï¼‰\n    totalValue: totalValue, // ç•¶å‰ç¸½åƒ¹å€¼ï¼ˆå°å¹£ï¼‰\n    profit: profit, // æç›Šï¼ˆå°å¹£ï¼‰\n    profitPercentage: profitPercentage, // æ”¶ç›Šç‡\n    profitStatus: profit >= 0 ? 'ç›ˆåˆ©' : 'è™§æ',\n    currency: currency, // åŸå§‹è²¨å¹£\n    exchangeRate: currency === 'USD' ? getExchangeRate() : 1, // ä½¿ç”¨çš„åŒ¯ç‡\n    apiSource: apiSource,\n    errorMessage: errorMessage,\n    hasError: errorMessage !== '',\n    lastUpdated: new Date().toLocaleString('zh-TW'),\n    reportDate: new Date().toLocaleDateString('zh-TW') // å ±å‘Šæ—¥æœŸ\n  };\n  \n  return { json: processedData };\n  \n} catch (error) {\n  // æ•ç²ä»»ä½•æœªé æœŸçš„éŒ¯èª¤\n  return {\n    json: {\n      symbol: 'ERROR',\n      formattedSymbol: 'ERROR',\n      stockName: 'è™•ç†éŒ¯èª¤',\n      shares: 0,\n      cost: 0,\n      currentPrice: 0,\n      totalValue: 0,\n      profit: 0,\n      profitPercentage: 0,\n      profitStatus: 'éŒ¯èª¤',\n      apiSource: 'è™•ç†å¤±æ•—',\n      errorMessage: `è™•ç†éŒ¯èª¤: ${error.message}`,\n      hasError: true,\n      lastUpdated: new Date().toLocaleString('zh-TW')\n    }\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        352,
        96
      ],
      "id": "2488a27d-532e-4436-bdc0-7ffb9491d30f",
      "name": "Process ETF Data"
    },
    {
      "parameters": {
        "url": "https://api.exchangerate-api.com/v4/latest/USD",
        "options": {
          "timeout": 10000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -400,
        96
      ],
      "id": "be5535ad-711c-4b97-bd20-7424b47ee1f6",
      "name": "Get Exchange Rate",
      "executeOnce": true
    }
  ],
  "pinData": {},
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Get Exchange Rate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get many rows": {
      "main": [
        [
          {
            "node": "Get ETF Price (Yahoo Finance)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get ETF Price (Yahoo Finance)": {
      "main": [
        [
          {
            "node": "Process ETF Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process ETF Data": {
      "main": [
        [
          {
            "node": "Send ETF Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Exchange Rate": {
      "main": [
        [
          {
            "node": "Get many rows",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "saveExecutionProgress": true
  },
  "versionId": "e5968eee-6cb2-42cf-b91b-dea0ad576120",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "6f079d2fd3a01e6d8b31442e3a4a565d558664b94577a455af30e07600845d5d"
  },
  "id": "zwaXgpDmCzLlD3pp",
  "tags": []
}