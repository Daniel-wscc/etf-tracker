<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETFè‚¡åƒ¹è¿½è¹¤è¡¨æ ¼</title>
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Varela+Round&display=swap" rel="stylesheet">

    <style>
        :root {
            --ac-green: #78C850;
            --ac-green-dark: #5DA537;
            --ac-cream: #FDFBEA;
            --ac-blue: #55C1DE;
            --ac-brown: #795548;
            --ac-brown-dark: #5D4037;
            --ac-yellow: #F9E076;
            --ac-orange: #FF9F43;
            --ac-red: #FF6B6B;
            --ac-text: #5D4037;
            --ac-border: #C7B299;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Varela Round', 'Nunito', sans-serif;
            background-color: var(--ac-cream);
            background-image: radial-gradient(var(--ac-green) 15%, transparent 16%),
                            radial-gradient(var(--ac-green) 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            color: var(--ac-text);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            box-shadow: 0 10px 0 rgba(0,0,0,0.1);
            overflow: hidden;
            border: 8px solid white;
            position: relative;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 15px;
            background: repeating-linear-gradient(
                45deg,
                var(--ac-blue),
                var(--ac-blue) 20px,
                white 20px,
                white 40px
            );
            z-index: 100;
        }

        .header {
            background: var(--ac-green);
            color: white;
            padding: 40px 20px 30px;
            text-align: center;
            position: relative;
            border-bottom: 5px dashed rgba(255,255,255,0.5);
        }

        .header h1 {
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
            background: white;
            color: var(--ac-green-dark);
            display: inline-block;
            padding: 10px 30px;
            border-radius: 50px;
            transform: rotate(-2deg);
            box-shadow: 3px 3px 0 rgba(0,0,0,0.1);
        }

        .header p {
            margin-top: 15px;
            font-size: 1.1em;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
        }

        .controls {
            padding: 30px;
            background: #fff;
            border-bottom: 2px dashed var(--ac-border);
        }

        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: var(--ac-cream);
            padding: 15px;
            border-radius: 20px;
            border: 2px solid var(--ac-border);
        }

        .control-group label {
            font-weight: bold;
            color: var(--ac-brown);
            font-size: 1.1em;
        }

        .control-group input, .control-group select, .card input, .flex-wrap input {
            padding: 10px 15px;
            border: 2px solid var(--ac-border);
            border-radius: 15px;
            font-size: 16px;
            font-family: 'Varela Round', sans-serif;
            color: var(--ac-brown);
            background: white;
            outline: none;
            transition: all 0.2s;
        }

        .control-group input:focus, .control-group select:focus, .card input:focus, .flex-wrap input:focus {
            border-color: var(--ac-blue);
            box-shadow: 0 0 0 3px rgba(85, 193, 222, 0.2);
        }

        .btn {
            background: var(--ac-blue);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            font-family: 'Varela Round', sans-serif;
            transition: all 0.1s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            transform: translateY(0);
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 rgba(0,0,0,0.1);
        }

        .btn:hover {
            filter: brightness(1.1);
        }

        .btn-success {
            background: var(--ac-green);
        }

        .btn-danger {
            background: var(--ac-red);
        }

        .table-container {
            overflow-x: auto;
            padding: 30px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            margin-top: 10px;
        }

        th, td {
            padding: 15px;
            text-align: center;
            font-size: 15px;
        }

        th {
            background: var(--ac-brown);
            color: white;
            font-weight: bold;
            border: none;
        }

        th:first-child { border-radius: 15px 0 0 15px; }
        th:last-child { border-radius: 0 15px 15px 0; }

        tr {
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        tbody tr {
            background: white;
        }

        tbody tr:hover {
            transform: scale(1.01);
            background: #fff;
            z-index: 10;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        tbody td {
            border-top: 2px solid var(--ac-cream);
            border-bottom: 2px solid var(--ac-cream);
        }

        tbody td:first-child {
            border-left: 2px solid var(--ac-cream);
            border-radius: 15px 0 0 15px;
            font-weight: bold;
            color: var(--ac-blue);
        }

        tbody td:last-child {
            border-right: 2px solid var(--ac-cream);
            border-radius: 0 15px 15px 0;
        }

        .positive {
            color: var(--ac-green-dark);
            font-weight: bold;
            background: rgba(120, 200, 80, 0.1);
            padding: 5px 10px;
            border-radius: 10px;
        }

        .negative {
            color: var(--ac-red);
            font-weight: bold;
            background: rgba(255, 107, 107, 0.1);
            padding: 5px 10px;
            border-radius: 10px;
        }

        .summary {
            padding: 30px;
            background: var(--ac-cream);
            border-top: 5px dashed var(--ac-border);
        }

        .summary h2 {
            color: var(--ac-brown);
            font-size: 1.8em;
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .summary h2::before, .summary h2::after {
            content: 'ğŸƒ';
            font-size: 0.8em;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .summary-item {
            background: white;
            padding: 20px;
            border-radius: 25px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.05);
            text-align: center;
            border: 2px solid var(--ac-border);
            position: relative;
            overflow: hidden;
        }
        
        .summary-item::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 30px;
            height: 30px;
            background: var(--ac-yellow);
            border-radius: 0 0 0 25px;
        }

        .summary-item h3 {
            color: var(--ac-brown);
            font-size: 16px;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .summary-item .value {
            font-size: 24px;
            font-weight: bold;
            color: var(--ac-blue);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        ::-webkit-scrollbar-track {
            background: var(--ac-cream);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--ac-border);
            border-radius: 6px;
            border: 3px solid var(--ac-cream);
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
                border: none;
            }
            
            .header h1 {
                font-size: 1.8em;
                transform: none;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 5px;
            }
        }

        /* New Helper Classes */
        .login-status {
            margin-top: 15px; 
            padding: 10px; 
            background: rgba(255,255,255,0.2); 
            border-radius: 15px; 
            font-size: 14px;
            border: 2px dashed rgba(255,255,255,0.5);
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 25px;
            margin-bottom: 20px;
            border: 2px solid var(--ac-border);
            box-shadow: 4px 4px 0 rgba(0,0,0,0.05);
        }

        .allocation-analysis {
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px;
        }

        .allocation-list {
            max-height: 300px; 
            overflow-y: auto;
            padding-right: 10px;
        }

        .allocation-advice {
            font-size: 15px; 
            line-height: 1.6;
            color: var(--ac-brown);
            background: var(--ac-cream);
            padding: 15px;
            border-radius: 15px;
        }

        .grid-inputs {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px; 
            margin-bottom: 15px;
        }

        .input-full {
            width: 100% !important;
        }

        .text-small {
            font-size: 12px; 
            color: var(--ac-brown); 
            opacity: 0.8;
        }
        
        .flex-wrap {
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ ETFè‚¡åƒ¹è¿½è¹¤è¡¨æ ¼</h1>
            <p>è¿½è¹¤æ‚¨çš„ETFæŠ•è³‡çµ„åˆï¼ŒåŒ…å«æˆæœ¬ã€è‚¡æ¯ã€ç¸½è³‡ç”¢ç­‰è³‡è¨Š</p>
            <div id="loginStatus" class="login-status">
                <span style="color: orange;">è¼‰å…¥ä¸­...</span>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>ETFä»£è™Ÿ:</label>
                <input type="text" id="etfSymbol" placeholder="ä¾‹å¦‚: 0050.TW" onchange="updateCostCurrency()">
                <label>è³¼è²·è‚¡æ•¸:</label>
                <input type="number" id="shares" placeholder="è‚¡æ•¸">
                <label>è³¼è²·æˆæœ¬:</label>
                <input type="number" id="cost" placeholder="æ¯è‚¡æˆæœ¬" step="0.01">
                <span id="costCurrency" class="text-small" style="margin-left: 5px;">TWD</span>
                <button class="btn btn-success" onclick="addETF()">æ–°å¢ETF</button>
            </div>
            <div class="control-group">
                <label>å¸¸è¦‹ETF:</label>
                <select id="popularETF" onchange="fillPopularETF()">
                    <option value="">é¸æ“‡ETF</option>
                    <option value="0050.TW">0050 å…ƒå¤§å°ç£50</option>
                    <option value="0056.TW">0056 å…ƒå¤§é«˜è‚¡æ¯</option>
                    <option value="00878.TW">00878 åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯</option>
                    <option value="00679B.TW">00679B å…ƒå¤§ç¾å‚µ20å¹´</option>
                    <option value="00692.TW">00692 å¯Œé‚¦å…¬å¸æ²»ç†</option>
                    <option value="00881.TW">00881 åœ‹æ³°å°ç£5G+</option>
                    <option value="VTI">VTI ç¾åœ‹æ•´é«”è‚¡å¸‚</option>
                    <option value="SPY">SPY æ¨™æ™®500</option>
                    <option value="QQQ">QQQ é‚£æ–¯é”å…‹100</option>
                </select>
                <button class="btn" onclick="showHelp()">â“ ä½¿ç”¨èªªæ˜</button>
            </div>
            <div class="control-group">
                <button class="btn" onclick="refreshAllPrices()">ğŸ”„ æ›´æ–°æ‰€æœ‰è‚¡åƒ¹</button>
                <button class="btn" onclick="updateExchangeRate()">ğŸ’± æ›´æ–°åŒ¯ç‡</button>
                <label>ç¾å…ƒåŒ¯ç‡:</label>
                <input type="number" id="usdRate" step="0.01" min="20" max="40" onchange="updateManualExchangeRate()">
                <span id="rateUpdate" class="text-small"></span>
            </div>
            <div class="control-group">
                <button class="btn" onclick="exportData()">ğŸ“¤ åŒ¯å‡ºè³‡æ–™</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData()">
                <button class="btn" onclick="document.getElementById('importFile').click()">ğŸ“¥ åŒ¯å…¥è³‡æ–™</button>
                <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
            </div>
        </div>

        <div class="table-container">
            <div id="loading" class="loading" style="display: none;">æ­£åœ¨è¼‰å…¥è‚¡åƒ¹è³‡æ–™...</div>
            <div id="error" class="error" style="display: none;"></div>
            
            <table id="etfTable">
                <thead>
                    <tr>
                        <th>ETFä»£è™Ÿ</th>
                        <th>è‚¡æ•¸</th>
                        <th>è³¼è²·æˆæœ¬</th>
                        <th>ç›®å‰è‚¡åƒ¹</th>
                        <th>æ¼²è·Œå¹…</th>
                        <th>å¸‚å€¼</th>
                        <th>é…ç½®æ¯”ä¾‹</th>
                        <th>ç¸½æˆæœ¬</th>
                        <th>æœªå¯¦ç¾æç›Š</th>
                        <th>å ±é…¬ç‡(%)</th>
                        <th>ç•¶å¹´é ˜æ¯</th>
                        <th>ç•¶å¹´ç¸½è³‡ç”¢</th>
                        <th>æ›´æ–°æ™‚é–“</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="etfTableBody">
                </tbody>
            </table>
        </div>

        <div class="summary">
            <h2 style="margin-bottom: 20px; text-align: center;">ğŸ“Š æŠ•è³‡çµ„åˆç¸½è¦½</h2>
            <div class="summary-grid">
                <div class="summary-item">
                    <h3>ç¸½æŠ•è³‡æˆæœ¬</h3>
                    <div class="value" id="totalCost">$0</div>
                </div>
                <div class="summary-item">
                    <h3>ç¸½å¸‚å€¼</h3>
                    <div class="value" id="totalValue">$0</div>
                </div>
                <div class="summary-item">
                    <h3>ç¸½æç›Š</h3>
                    <div class="value" id="totalPnL">$0</div>
                </div>
                <div class="summary-item">
                    <h3>ç¸½å ±é…¬ç‡</h3>
                    <div class="value" id="totalReturn">0%</div>
                </div>
                <div class="summary-item">
                    <h3>ç•¶å¹´ç¸½é ˜æ¯</h3>
                    <div class="value" id="totalDividend">$0</div>
                </div>
                <div class="summary-item">
                    <h3>ç•¶å¹´ç¸½è³‡ç”¢</h3>
                    <div class="value" id="totalAssets">$0</div>
                </div>
            </div>
            
            <!-- è³‡ç”¢é…ç½®åˆ†æ -->
            <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
                <h3 style="margin-bottom: 15px; text-align: center;">ğŸ“Š è³‡ç”¢é…ç½®åˆ†æ</h3>
                <div id="allocationAnalysis" class="allocation-analysis">
                    <!-- é…ç½®åˆ—è¡¨ -->
                    <div>
                        <h4 style="margin-bottom: 10px;">é…ç½®æ˜ç´°</h4>
                        <div id="allocationList" class="allocation-list">
                        </div>
                    </div>
                    
                    <!-- é…ç½®å»ºè­° -->
                    <div>
                        <h4 style="margin-bottom: 10px;">é…ç½®å»ºè­°</h4>
                        <div id="allocationAdvice" class="allocation-advice">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GKå‹•æ…‹æé ˜æ³•å€å¡Š -->
        <div class="summary">
            <h2 style="margin-bottom: 20px; text-align: center;">ğŸ¯ GKå‹•æ…‹æé ˜æ³•</h2>
            
            <!-- GKè¨­å®šå€ -->
            <div class="card">
                <h3 style="margin-bottom: 15px;">âš™ï¸ GKæé ˜è¨­å®š</h3>
                <div class="grid-inputs">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">åˆå§‹æé ˜ç‡ (%):</label>
                        <input type="number" id="initialRate" step="0.1" min="0" max="10" class="input-full">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">æŠ•è³‡çµ„åˆèµ·å§‹åƒ¹å€¼:</label>
                        <input type="number" id="startValue" step="1000" min="0" class="input-full">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">æœ€å¤§å¢å¹… (%):</label>
                        <input type="number" id="maxIncrease" step="1" min="0" max="50" class="input-full">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">æœ€å¤§æ¸›å¹… (%):</label>
                        <input type="number" id="maxDecrease" step="1" min="0" max="50" class="input-full">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å‰ä¸€å¹´é€šè†¨ç‡ (%):</label>
                        <input type="number" id="inflationRate" step="0.1" class="input-full">
                    </div>
                </div>
                <div style="text-align: center;">
                    <button class="btn btn-success" onclick="enableGK()">å•Ÿç”¨GKæé ˜æ³•</button>
                    <button class="btn" onclick="updateGKSettings()">æ›´æ–°è¨­å®š</button>
                    <button class="btn btn-danger" onclick="disableGK()">åœç”¨GKæé ˜æ³•</button>
                </div>
            </div>

            <!-- GKç‹€æ…‹é¡¯ç¤º -->
            <div id="gkStatus" class="card">
                <h3 style="margin-bottom: 15px;">ğŸ“ˆ ç›®å‰GKç‹€æ…‹</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <h3>GKç‹€æ…‹</h3>
                        <div class="value" id="gkEnabled">æœªå•Ÿç”¨</div>
                    </div>
                    <div class="summary-item">
                        <h3>å»ºè­°æé ˜é‡‘é¡</h3>
                        <div class="value" id="suggestedWithdrawal">$0</div>
                    </div>
                    <div class="summary-item">
                        <h3>ç›®å‰æé ˜ç‡</h3>
                        <div class="value" id="currentRate">0%</div>
                    </div>
                    <div class="summary-item">
                        <h3>èˆ‡åˆå§‹æé ˜ç‡å·®ç•°</h3>
                        <div class="value" id="rateDifference">0%</div>
                    </div>
                </div>
            </div>

            <!-- å¹´åº¦è¨˜éŒ„å€ -->
            <div class="card">
                <h3 style="margin-bottom: 15px;">ğŸ“… å¹´åº¦å ±é…¬ç‡è¨˜éŒ„</h3>
                <div class="flex-wrap">
                    <input type="number" id="recordYear" placeholder="å¹´ä»½" min="2000" max="2100" style="width: 100px;">
                    <input type="number" id="yearReturn" placeholder="å ±é…¬ç‡ (%)" step="0.01" style="width: 120px;">
                    <input type="number" id="yearStartValue" placeholder="å¹´åˆè³‡ç”¢" step="1000" style="width: 120px;">
                    <input type="number" id="yearEndValue" placeholder="å¹´æœ«è³‡ç”¢" step="1000" style="width: 120px;">
                    <input type="number" id="yearWithdrawal" placeholder="å¯¦éš›æé ˜" step="1000" style="width: 120px;">
                    <input type="number" id="yearInflation" placeholder="é€šè†¨ç‡ (%)" step="0.01" style="width: 120px;">
                    <button class="btn btn-success" onclick="addYearlyRecord()">æ–°å¢è¨˜éŒ„</button>
                    <button class="btn" onclick="autoCalculateCurrentYear()">è‡ªå‹•è¨ˆç®—æœ¬å¹´</button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table id="yearlyTable" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; border: 1px solid #dee2e6;">å¹´ä»½</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6;">å¹´åˆè³‡ç”¢</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6;">å¹´æœ«è³‡ç”¢</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6;">å ±é…¬ç‡</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6;">é€šè†¨ç‡</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6;">å¯¦éš›æé ˜</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6;">å»ºè­°æé ˜</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6;">æé ˜ç‡</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6;">è§¸ç™¼è¦å‰‡</th>
                                <th style="padding: 10px; border: 1px solid #dee2e6;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="yearlyTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== Supabase è¨­å®š ====================
        const SUPABASE_URL = 'https://nowllpnpkildcbgjrivz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vd2xscG5wa2lsZGNiZ2pyaXZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4OTczMzksImV4cCI6MjA3MDQ3MzMzOX0.pVt0-WPq20WIJS4h9gPKFDYPBZU0FAdncHbmv-h7qjI';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                redirectTo: 'https://demo.wscc1031.synology.me/etf-tracker/'
            }
        });

        // ç”¨æˆ¶ç‹€æ…‹
        let currentUser = null;
        let isOnline = navigator.onLine;
        let syncInProgress = false;
        let autoSyncEnabled = true;
        let lastSyncTime = 0;
        let syncQueue = false;

        // ç›£è½ç¶²è·¯ç‹€æ…‹
        window.addEventListener('online', () => {
            isOnline = true;
            console.log('ç¶²è·¯å·²é€£ç·šï¼Œæº–å‚™åŒæ­¥è³‡æ–™');
            if (currentUser) {
                syncAllDataToCloud();
            }
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            console.log('ç¶²è·¯å·²æ–·ç·šï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™');
        });

        // ==================== æœ¬åœ°è³‡æ–™ ====================
        let etfData = JSON.parse(localStorage.getItem('etfData')) || [];
        let yearlyData = JSON.parse(localStorage.getItem('yearlyData')) || [];
        let gkSettings = JSON.parse(localStorage.getItem('gkSettings')) || {
            initialWithdrawalRate: 4.0,
            currentWithdrawalAmount: 0,
            portfolioStartValue: 0,
            maxIncrease: 10,
            maxDecrease: 10,
            enabled: false
        };
        let exchangeRate = JSON.parse(localStorage.getItem('exchangeRate')) || {
            usdToTwd: 31.5,
            lastUpdate: null
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // è¼‰å…¥è‡ªå‹•åŒæ­¥è¨­å®š
            const savedAutoSync = localStorage.getItem('autoSyncEnabled');
            if (savedAutoSync !== null) {
                autoSyncEnabled = JSON.parse(savedAutoSync);
            }

            // ä¿®å¾©ç¾æœ‰è³‡æ–™çš„ç¼ºå¤±æ¬„ä½
            fixExistingData();

            // æª¢æŸ¥ç”¨æˆ¶ç™»å…¥ç‹€æ…‹
            await checkUserSession();

            // å¦‚æœæœ‰ç”¨æˆ¶ç™»å…¥ä¸”ç¶²è·¯é€£ç·šï¼Œå¾é›²ç«¯è¼‰å…¥è³‡æ–™
            if (currentUser && isOnline) {
                await loadDataFromCloud();
            }

            renderTable();
            updateSummary();
            renderYearlyData();
            updateGKDisplay();
            updateExchangeRateDisplay();

            // é¡¯ç¤ºç™»å…¥ç‹€æ…‹
            updateLoginStatus();
        });

        // æ–°å¢ETF
        function addETF() {
            const symbol = document.getElementById('etfSymbol').value.trim();
            const shares = parseFloat(document.getElementById('shares').value);
            const inputCost = parseFloat(document.getElementById('cost').value);

            if (!symbol || !shares || !inputCost) {
                alert('è«‹å¡«å…¥å®Œæ•´çš„ETFè³‡è¨Š');
                return;
            }

            // åˆ¤æ–·æ˜¯å¦ç‚ºç¾è‚¡ï¼Œå¦‚æœæ˜¯ç¾è‚¡å‰‡å°‡æˆæœ¬è½‰æ›ç‚ºå°å¹£
            const isUSStock = !isTaiwanStock(symbol);
            let costInTWD = inputCost;
            let originalCost = inputCost;
            
            if (isUSStock) {
                costInTWD = inputCost * exchangeRate.usdToTwd;
                originalCost = inputCost; // ä¿å­˜åŸå§‹ç¾å…ƒæˆæœ¬
            }

            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existingIndex = etfData.findIndex(item => item.symbol === symbol);
            if (existingIndex !== -1) {
                if (confirm('æ­¤ETFå·²å­˜åœ¨ï¼Œæ˜¯å¦è¦æ›´æ–°è³‡æ–™ï¼Ÿ')) {
                    etfData[existingIndex].shares = shares;
                    etfData[existingIndex].cost = Math.round(costInTWD * 100) / 100;
                    etfData[existingIndex].originalCost = isUSStock ? originalCost : null;
                    etfData[existingIndex].currency = isUSStock ? 'USD' : 'TWD';
                }
            } else {
                const newETF = {
                    symbol: symbol,
                    name: symbol, // æš«æ™‚ä½¿ç”¨ symbol ä½œç‚º nameï¼Œå¾ŒçºŒå¯ä»¥é€é API ç²å–æ­£ç¢ºåç¨±
                    shares: shares,
                    cost: Math.round(costInTWD * 100) / 100,
                    originalCost: isUSStock ? originalCost : null,
                    currency: isUSStock ? 'USD' : 'TWD',
                    currentPrice: 0,
                    dividend: 0,
                    totalAssets: 0,
                    lastUpdate: null
                };
                etfData.push(newETF);
            }

            // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById('etfSymbol').value = '';
            document.getElementById('shares').value = '';
            document.getElementById('cost').value = '';
            updateCostCurrency(); // é‡ç½®è²¨å¹£é¡¯ç¤º

            saveData();
            renderTable();
            updateSummary();
            
            // è‡ªå‹•ç²å–è‚¡åƒ¹
            if (existingIndex === -1) {
                fetchPrice(symbol);
            }
        }

        // ç²å–è‚¡åƒ¹ (ä½¿ç”¨å°ç£è­‰äº¤æ‰€çœŸå¯¦API)
        async function fetchPrice(symbol) {
            const index = etfData.findIndex(item => item.symbol === symbol);
            if (index === -1) return;

            try {
                showLoading(true);
                
                // åˆ¤æ–·æ˜¯å°ç£è‚¡ç¥¨é‚„æ˜¯åœ‹å¤–è‚¡ç¥¨
                if (isTaiwanStock(symbol)) {
                    await fetchTaiwanPrice(symbol, index);
                } else {
                    await fetchInternationalPrice(symbol, index);
                }
                
                saveData();
                renderTable();
                updateSummary();
                
            } catch (error) {
                showError('ç²å–è‚¡åƒ¹å¤±æ•—: ' + error.message);
                console.error('Error fetching price:', error);
            } finally {
                showLoading(false);
            }
        }

        // åˆ¤æ–·æ˜¯å¦ç‚ºå°ç£è‚¡ç¥¨
        function isTaiwanStock(symbol) {
            return symbol.toLowerCase().includes('.tw') || 
                   /^\d{4}$/.test(symbol) || 
                   /^\d{5}$/.test(symbol);
        }

        // ç²å–å°ç£è‚¡åƒ¹
        async function fetchTaiwanPrice(symbol, index) {
            // è™•ç†è‚¡ç¥¨ä»£è™Ÿæ ¼å¼
            let stockCode = symbol.replace('.TW', '').replace('.tw', '');
            
            // åˆ¤æ–·äº¤æ˜“æ‰€
            let exchange = 'tse'; // é è¨­ç‚ºä¸Šå¸‚
            if (stockCode.startsWith('00') || parseInt(stockCode) >= 6000) {
                exchange = 'otc'; // ä¸Šæ«ƒ
            }
            
            const apiUrl = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?json=1&delay=0&ex_ch=${exchange}_${stockCode}.tw`;
            
            try {
                // ä½¿ç”¨ä»£ç†æœå‹™ä¾†é¿å…CORSå•é¡Œ
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(apiUrl)}`;
                const response = await fetch(proxyUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const stockData = JSON.parse(data.contents);
                
                if (stockData.msgArray && stockData.msgArray.length > 0) {
                    const stock = stockData.msgArray[0];
                    const price = parseFloat(stock.z) || parseFloat(stock.y); // zæ˜¯æˆäº¤åƒ¹ï¼Œyæ˜¯æ˜¨æ”¶åƒ¹
                    
                    if (price && price > 0) {
                        etfData[index].currentPrice = price;
                        etfData[index].lastUpdate = getCurrentTimeString();
                        etfData[index].priceChange = stock.z ? parseFloat(stock.z) - parseFloat(stock.y) : 0;
                        etfData[index].priceChangePercent = stock.z ? ((parseFloat(stock.z) - parseFloat(stock.y)) / parseFloat(stock.y) * 100) : 0;
                        // æ¸…é™¤å¤±æ•—æ¨™è¨˜
                        delete etfData[index].priceUpdateFailed;
                    } else {
                        throw new Error('ç„¡æ³•å–å¾—æœ‰æ•ˆè‚¡åƒ¹');
                    }
                } else {
                    throw new Error('æ‰¾ä¸åˆ°è‚¡ç¥¨è³‡æ–™ï¼Œè«‹æª¢æŸ¥è‚¡ç¥¨ä»£è™Ÿ');
                }
            } catch (error) {
                // å¦‚æœAPIå¤±æ•—ï¼Œå˜—è©¦å‚™ç”¨æ–¹æ¡ˆ
                console.warn('ä¸»è¦APIå¤±æ•—:', error);
                await fetchTaiwanPriceBackup(symbol, index);
            }
        }

        // å°ç£è‚¡åƒ¹å‚™ç”¨API
        async function fetchTaiwanPriceBackup(symbol, index) {
            try {
                // ä½¿ç”¨Yahoo Financeä½œç‚ºå‚™ç”¨
                const yahooSymbol = symbol.includes('.TW') ? symbol : symbol + '.TW';
                const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(yahooUrl)}`;

                const response = await fetch(proxyUrl);
                const data = await response.json();
                const yahooData = JSON.parse(data.contents);

                if (yahooData.chart && yahooData.chart.result && yahooData.chart.result.length > 0) {
                    const result = yahooData.chart.result[0];
                    const price = result.meta.regularMarketPrice || result.meta.previousClose;

                    if (price && price > 0) {
                        etfData[index].currentPrice = Math.round(price * 100) / 100;
                        etfData[index].lastUpdate = getCurrentTimeString();
                        // æ¸…é™¤å¤±æ•—æ¨™è¨˜
                        delete etfData[index].priceUpdateFailed;
                    } else {
                        throw new Error('å‚™ç”¨APIä¹Ÿç„¡æ³•å–å¾—è‚¡åƒ¹');
                    }
                } else {
                    throw new Error('å‚™ç”¨APIå›æ‡‰æ ¼å¼éŒ¯èª¤');
                }
            } catch (error) {
                // æ‰€æœ‰APIéƒ½å¤±æ•—ï¼Œæ¨™è¨˜ç‚ºå¤±æ•—ç‹€æ…‹
                console.warn('æ‰€æœ‰APIéƒ½å¤±æ•—:', error);
                etfData[index].priceUpdateFailed = true;
                etfData[index].lastUpdate = getCurrentTimeString() + ' (æ›´æ–°å¤±æ•—)';
            }
        }

        // ç²å–åœ‹éš›è‚¡åƒ¹ (ä½¿ç”¨Yahoo Finance)
        async function fetchInternationalPrice(symbol, index) {
            try {
                const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(yahooUrl)}`;

                const response = await fetch(proxyUrl);
                const data = await response.json();
                const yahooData = JSON.parse(data.contents);

                if (yahooData.chart && yahooData.chart.result && yahooData.chart.result.length > 0) {
                    const result = yahooData.chart.result[0];
                    const usdPrice = result.meta.regularMarketPrice || result.meta.previousClose;
                    const currency = result.meta.currency || 'USD';

                    if (usdPrice && usdPrice > 0) {
                        // å¦‚æœæ˜¯ç¾å…ƒï¼Œè½‰æ›æˆå°å¹£
                        let twdPrice = usdPrice;
                        if (currency === 'USD') {
                            twdPrice = usdPrice * exchangeRate.usdToTwd;
                        }

                        etfData[index].currentPrice = Math.round(twdPrice * 100) / 100;
                        etfData[index].originalPrice = usdPrice; // ä¿å­˜åŸå§‹ç¾å…ƒåƒ¹æ ¼
                        etfData[index].currency = currency;
                        etfData[index].lastUpdate = getCurrentTimeString();
                        // æ¸…é™¤å¤±æ•—æ¨™è¨˜
                        delete etfData[index].priceUpdateFailed;
                    } else {
                        throw new Error('ç„¡æ³•å–å¾—æœ‰æ•ˆè‚¡åƒ¹');
                    }
                } else {
                    throw new Error('æ‰¾ä¸åˆ°è‚¡ç¥¨è³‡æ–™');
                }
            } catch (error) {
                console.warn('åœ‹éš›è‚¡åƒ¹APIå¤±æ•—ï¼Œç¶­æŒåŸæœ¬åƒ¹æ ¼:', error);
                etfData[index].priceUpdateFailed = true;
                etfData[index].lastUpdate = getCurrentTimeString() + ' (æ›´æ–°å¤±æ•—)';
            }
        }



        // æ›´æ–°æ‰€æœ‰è‚¡åƒ¹
        async function refreshAllPrices() {
            if (etfData.length === 0) {
                alert('è«‹å…ˆæ–°å¢ETF');
                return;
            }

            showLoading(true);
            
            for (let i = 0; i < etfData.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 500)); // é¿å…APIé™åˆ¶
                await fetchPrice(etfData[i].symbol);
            }
            
            showLoading(false);
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const tbody = document.getElementById('etfTableBody');
            tbody.innerHTML = '';

            // è¨ˆç®—ç¸½å¸‚å€¼ç”¨æ–¼é…ç½®æ¯”ä¾‹è¨ˆç®—
            let totalPortfolioValue = 0;
            etfData.forEach(item => {
                totalPortfolioValue += item.currentPrice * item.shares;
            });

            etfData.forEach((item, index) => {
                const row = document.createElement('tr');

                // å¦‚æœè‚¡åƒ¹æ›´æ–°å¤±æ•—ï¼Œæ·»åŠ ç´…è‰²èƒŒæ™¯æ¨£å¼
                if (item.priceUpdateFailed) {
                    row.classList.add('price-update-failed');
                }

                const marketValue = item.currentPrice * item.shares;
                const totalCost = item.cost * item.shares;
                const pnl = marketValue - totalCost;
                const returnRate = totalCost > 0 ? (pnl / totalCost * 100) : 0;
                const totalAssetsWithDividend = marketValue + item.dividend;

                // è¨ˆç®—é…ç½®æ¯”ä¾‹
                const allocationPercentage = totalPortfolioValue > 0 ? (marketValue / totalPortfolioValue * 100) : 0;

                // è¨ˆç®—æ¼²è·Œå¹…é¡¯ç¤º
                const priceChangePercent = item.priceChangePercent || 0;
                const priceChangeDisplay = priceChangePercent !== 0 ? 
                    `<span class="${priceChangePercent >= 0 ? 'positive' : 'negative'}">${priceChangePercent >= 0 ? '+' : ''}${priceChangePercent.toFixed(2)}%</span>` : 
                    '<span style="color: #666;">--</span>';

                // åƒ¹æ ¼é¡¯ç¤ºï¼šå¦‚æœæ˜¯ç¾è‚¡ï¼Œé¡¯ç¤ºå°å¹£åƒ¹æ ¼å’ŒåŸå§‹ç¾å…ƒåƒ¹æ ¼
                let priceDisplay = `$${item.currentPrice.toFixed(2)}`;
                if (item.currency === 'USD' && item.originalPrice) {
                    priceDisplay = `$${item.currentPrice.toFixed(2)}<br><small style="color: #666;">($${item.originalPrice.toFixed(2)} USD)</small>`;
                }

                // æˆæœ¬é¡¯ç¤ºï¼šå¦‚æœæ˜¯ç¾è‚¡ï¼Œé¡¯ç¤ºå°å¹£æˆæœ¬å’ŒåŸå§‹ç¾å…ƒæˆæœ¬
                let costDisplay = `$${item.cost.toFixed(2)}`;
                if (item.currency === 'USD' && item.originalCost) {
                    costDisplay = `$${item.cost.toFixed(2)}<br><small style="color: #666;">($${item.originalCost.toFixed(2)} USD)</small>`;
                }

                // é…ç½®æ¯”ä¾‹é¡¯ç¤ºï¼Œæ ¹æ“šæ¯”ä¾‹å¤§å°ä½¿ç”¨ä¸åŒé¡è‰²
                let allocationColor = '#333';
                if (allocationPercentage >= 30) allocationColor = '#dc3545'; // ç´…è‰²ï¼šé«˜é…ç½®
                else if (allocationPercentage >= 20) allocationColor = '#fd7e14'; // æ©™è‰²ï¼šä¸­é«˜é…ç½®
                else if (allocationPercentage >= 10) allocationColor = '#ffc107'; // é»ƒè‰²ï¼šä¸­é…ç½®
                else if (allocationPercentage >= 5) allocationColor = '#28a745'; // ç¶ è‰²ï¼šä½é…ç½®
                else allocationColor = '#6c757d'; // ç°è‰²ï¼šæ¥µä½é…ç½®

                const allocationDisplay = `<span style="color: ${allocationColor}; font-weight: bold;">${allocationPercentage.toFixed(1)}%</span>`;

                row.innerHTML = `
                    <td><strong>${item.symbol}</strong></td>
                    <td>${item.shares.toLocaleString()}</td>
                    <td>${costDisplay}</td>
                    <td>${priceDisplay}</td>
                    <td>${priceChangeDisplay}</td>
                    <td>$${marketValue.toLocaleString('zh-TW', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                    <td>${allocationDisplay}</td>
                    <td>$${totalCost.toLocaleString('zh-TW', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                    <td class="${pnl >= 0 ? 'positive' : 'negative'}">$${pnl.toLocaleString('zh-TW', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                    <td class="${returnRate >= 0 ? 'positive' : 'negative'}">${returnRate.toFixed(2)}%</td>
                    <td class="editable" onclick="editDividend(${index})">$${item.dividend.toLocaleString('zh-TW', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                    <td>$${totalAssetsWithDividend.toLocaleString('zh-TW', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                    <td>${item.lastUpdate || 'æœªæ›´æ–°'}</td>
                    <td>
                        <button class="btn" onclick="fetchPrice('${item.symbol}')" style="padding: 5px 10px; font-size: 12px;">æ›´æ–°</button>
                        <button class="btn btn-danger" onclick="removeETF(${index})" style="padding: 5px 10px; font-size: 12px;">åˆªé™¤</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // ç·¨è¼¯è‚¡æ¯
        function editDividend(index) {
            const currentDividend = etfData[index].dividend;
            const newDividend = prompt('è«‹è¼¸å…¥ç•¶å¹´é ˜æ¯é‡‘é¡:', currentDividend);
            
            if (newDividend !== null && !isNaN(newDividend)) {
                etfData[index].dividend = parseFloat(newDividend);
                saveData();
                renderTable();
                updateSummary();
            }
        }

        // åˆªé™¤ETF
        function removeETF(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ETFå—ï¼Ÿ')) {
                etfData.splice(index, 1);
                saveData();
                renderTable();
                updateSummary();
            }
        }

        // æ›´æ–°ç¸½è¦½
        function updateSummary() {
            let totalCost = 0;
            let totalValue = 0;
            let totalDividend = 0;

            etfData.forEach(item => {
                totalCost += item.cost * item.shares;
                totalValue += item.currentPrice * item.shares;
                totalDividend += item.dividend;
            });

            const totalPnL = totalValue - totalCost;
            const totalReturn = totalCost > 0 ? (totalPnL / totalCost * 100) : 0;
            const totalAssets = totalValue + totalDividend;

            document.getElementById('totalCost').textContent = `$${totalCost.toLocaleString('zh-TW', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            document.getElementById('totalValue').textContent = `$${totalValue.toLocaleString('zh-TW', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            
            const pnlElement = document.getElementById('totalPnL');
            pnlElement.textContent = `$${totalPnL.toLocaleString('zh-TW', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            pnlElement.className = `value ${totalPnL >= 0 ? 'positive' : 'negative'}`;
            
            const returnElement = document.getElementById('totalReturn');
            returnElement.textContent = `${totalReturn.toFixed(2)}%`;
            returnElement.className = `value ${totalReturn >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('totalDividend').textContent = `$${totalDividend.toLocaleString('zh-TW', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            document.getElementById('totalAssets').textContent = `$${totalAssets.toLocaleString('zh-TW', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            
            // æ›´æ–°è³‡ç”¢é…ç½®åˆ†æ
            updateAllocationAnalysis(totalValue);
        }

        // æ›´æ–°è³‡ç”¢é…ç½®åˆ†æ
        function updateAllocationAnalysis(totalValue) {
            const allocationList = document.getElementById('allocationList');
            const allocationAdvice = document.getElementById('allocationAdvice');
            
            if (etfData.length === 0 || totalValue === 0) {
                allocationList.innerHTML = '<p style="color: #666; text-align: center;">æš«ç„¡è³‡æ–™</p>';
                allocationAdvice.innerHTML = '<p style="color: #666;">è«‹å…ˆæ–°å¢ETFä¸¦æ›´æ–°è‚¡åƒ¹</p>';
                return;
            }

            // è¨ˆç®—æ¯å€‹ETFçš„é…ç½®æ¯”ä¾‹ä¸¦æ’åº
            const allocations = etfData.map(item => {
                const marketValue = item.currentPrice * item.shares;
                const percentage = (marketValue / totalValue * 100);
                return {
                    symbol: item.symbol,
                    marketValue: marketValue,
                    percentage: percentage,
                    currency: item.currency || 'TWD'
                };
            }).sort((a, b) => b.percentage - a.percentage);

            // æ¸²æŸ“é…ç½®åˆ—è¡¨
            let listHTML = '';
            allocations.forEach((allocation, index) => {
                let barColor = '#6c757d';
                if (allocation.percentage >= 30) barColor = '#dc3545';
                else if (allocation.percentage >= 20) barColor = '#fd7e14';
                else if (allocation.percentage >= 10) barColor = '#ffc107';
                else if (allocation.percentage >= 5) barColor = '#28a745';

                const barWidth = Math.max(allocation.percentage, 2); // æœ€å°å¯¬åº¦2%ä»¥ä¾¿é¡¯ç¤º

                listHTML += `
                    <div style="margin-bottom: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-weight: bold;">${allocation.symbol}</span>
                            <span style="color: ${barColor}; font-weight: bold;">${allocation.percentage.toFixed(1)}%</span>
                        </div>
                        <div style="background: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: ${barColor}; height: 100%; width: ${barWidth}%; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 2px;">
                            $${allocation.marketValue.toLocaleString('zh-TW', {minimumFractionDigits: 0, maximumFractionDigits: 0})}
                        </div>
                    </div>
                `;
            });
            allocationList.innerHTML = listHTML;

            // ç”Ÿæˆé…ç½®å»ºè­°
            let adviceHTML = '';
            
            // åˆ†æé…ç½®é›†ä¸­åº¦
            const topThreePercentage = allocations.slice(0, 3).reduce((sum, item) => sum + item.percentage, 0);
            const maxAllocation = allocations[0]?.percentage || 0;
            
            // åˆ†æåœ°å€é…ç½®
            const taiwanETFs = allocations.filter(item => item.currency === 'TWD' || item.currency !== 'USD');
            const usETFs = allocations.filter(item => item.currency === 'USD');
            const taiwanPercentage = taiwanETFs.reduce((sum, item) => sum + item.percentage, 0);
            const usPercentage = usETFs.reduce((sum, item) => sum + item.percentage, 0);

            adviceHTML += '<div style="margin-bottom: 15px;">';
            adviceHTML += '<h5 style="color: #495057; margin-bottom: 8px;">ğŸ¯ é…ç½®åˆ†æ</h5>';
            
            if (maxAllocation > 50) {
                adviceHTML += '<p style="color: #dc3545;">âš ï¸ å–®ä¸€æ¨™çš„é…ç½®éé«˜ (' + maxAllocation.toFixed(1) + '%)ï¼Œå»ºè­°åˆ†æ•£æŠ•è³‡</p>';
            } else if (maxAllocation > 30) {
                adviceHTML += '<p style="color: #fd7e14;">âš¡ å–®ä¸€æ¨™çš„é…ç½®è¼ƒé«˜ (' + maxAllocation.toFixed(1) + '%)ï¼Œæ³¨æ„é¢¨éšªæ§åˆ¶</p>';
            } else {
                adviceHTML += '<p style="color: #28a745;">âœ… é…ç½®åˆ†æ•£åº¦è‰¯å¥½ï¼Œé¢¨éšªç›¸å°åˆ†æ•£</p>';
            }

            if (topThreePercentage > 80) {
                adviceHTML += '<p style="color: #dc3545;">âš ï¸ å‰ä¸‰å¤§æ¨™çš„ä½”æ¯”éé«˜ (' + topThreePercentage.toFixed(1) + '%)ï¼Œå»ºè­°å¢åŠ å…¶ä»–æ¨™çš„</p>';
            }
            adviceHTML += '</div>';

            adviceHTML += '<div style="margin-bottom: 15px;">';
            adviceHTML += '<h5 style="color: #495057; margin-bottom: 8px;">ğŸŒ åœ°å€é…ç½®</h5>';
            if (taiwanPercentage > 0) {
                adviceHTML += '<p>ğŸ‡¹ğŸ‡¼ å°è‚¡/å°å¹£: ' + taiwanPercentage.toFixed(1) + '%</p>';
            }
            if (usPercentage > 0) {
                adviceHTML += '<p>ğŸ‡ºğŸ‡¸ ç¾è‚¡: ' + usPercentage.toFixed(1) + '%</p>';
            }
            
            if (taiwanPercentage > 70) {
                adviceHTML += '<p style="color: #fd7e14;">ğŸ’¡ å»ºè­°å¢åŠ åœ‹éš›é…ç½®ä»¥åˆ†æ•£åœ°å€é¢¨éšª</p>';
            } else if (usPercentage > 70) {
                adviceHTML += '<p style="color: #fd7e14;">ğŸ’¡ å»ºè­°å¢åŠ å°è‚¡é…ç½®ä»¥å¹³è¡¡åŒ¯ç‡é¢¨éšª</p>';
            } else if (taiwanPercentage > 0 && usPercentage > 0) {
                adviceHTML += '<p style="color: #28a745;">âœ… åœ°å€é…ç½®å¹³è¡¡ï¼Œæœ‰åŠ©åˆ†æ•£é¢¨éšª</p>';
            }
            adviceHTML += '</div>';

            adviceHTML += '<div>';
            adviceHTML += '<h5 style="color: #495057; margin-bottom: 8px;">ğŸ“Š å»ºè­°é…ç½®</h5>';
            adviceHTML += '<p style="font-size: 13px; color: #666;">â€¢ å–®ä¸€æ¨™çš„å»ºè­°ä¸è¶…é30%</p>';
            adviceHTML += '<p style="font-size: 13px; color: #666;">â€¢ å‰äº”å¤§æ¨™çš„å»ºè­°ä¸è¶…é80%</p>';
            adviceHTML += '<p style="font-size: 13px; color: #666;">â€¢ è€ƒæ…®åœ°å€åˆ†æ•£ï¼šå°è‚¡50-70%ï¼Œåœ‹éš›30-50%</p>';
            adviceHTML += '</div>';

            allocationAdvice.innerHTML = adviceHTML;
        }

        // å„²å­˜è³‡æ–™
        function saveData() {
            saveToLocalStorage();
        }

        // åŒ¯å‡ºè³‡æ–™
        function exportData() {
            if (etfData.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º');
                return;
            }

            const dataStr = JSON.stringify(etfData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `etf_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        // åŒ¯å…¥è³‡æ–™
        function importData() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        etfData = importedData;
                        saveData();
                        renderTable();
                        updateSummary();
                        alert('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
                    } else {
                        alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                    }
                } catch (error) {
                    alert('æª”æ¡ˆè®€å–å¤±æ•—: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // æ¸…é™¤æ‰€æœ‰è³‡æ–™
        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                etfData = [];
                saveData();
                renderTable();
                updateSummary();
            }
        }

        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // å¡«å…¥å¸¸è¦‹ETF
        function fillPopularETF() {
            const select = document.getElementById('popularETF');
            const symbol = select.value;
            if (symbol) {
                document.getElementById('etfSymbol').value = symbol;
                select.value = ''; // é‡ç½®é¸æ“‡
                updateCostCurrency(); // æ›´æ–°è²¨å¹£é¡¯ç¤º
            }
        }

        // æ›´æ–°æˆæœ¬è²¨å¹£é¡¯ç¤º
        function updateCostCurrency() {
            const symbol = document.getElementById('etfSymbol').value.trim();
            const costCurrencySpan = document.getElementById('costCurrency');
            const costInput = document.getElementById('cost');
            
            if (symbol && !isTaiwanStock(symbol)) {
                costCurrencySpan.textContent = 'USD';
                costInput.placeholder = 'æ¯è‚¡æˆæœ¬ (ç¾å…ƒ)';
            } else {
                costCurrencySpan.textContent = 'TWD';
                costInput.placeholder = 'æ¯è‚¡æˆæœ¬ (å°å¹£)';
            }
        }

        // é¡¯ç¤ºä½¿ç”¨èªªæ˜
        function showHelp() {
            const helpText = `
ğŸ“ˆ ETFè‚¡åƒ¹è¿½è¹¤è¡¨æ ¼ + GKå‹•æ…‹æé ˜æ³•ä½¿ç”¨èªªæ˜

ğŸ¯ åŸºæœ¬åŠŸèƒ½ï¼š
â€¢ æ–°å¢ETFï¼šè¼¸å…¥ä»£è™Ÿã€è‚¡æ•¸ã€æˆæœ¬å¾Œé»æ“Šã€Œæ–°å¢ETFã€
â€¢ æ›´æ–°è‚¡åƒ¹ï¼šé»æ“Šã€Œæ›´æ–°æ‰€æœ‰è‚¡åƒ¹ã€æˆ–å€‹åˆ¥ã€Œæ›´æ–°ã€æŒ‰éˆ•
â€¢ ç·¨è¼¯è‚¡æ¯ï¼šé»æ“Šè¡¨æ ¼ä¸­çš„ã€Œç•¶å¹´é ˜æ¯ã€æ¬„ä½å¯ç·¨è¼¯é‡‘é¡
â€¢ è³‡æ–™ç®¡ç†ï¼šæ”¯æ´åŒ¯å‡º/åŒ¯å…¥JSONæ ¼å¼è³‡æ–™

ğŸ“Š æ”¯æ´çš„è‚¡ç¥¨æ ¼å¼ï¼š
â€¢ å°ç£è‚¡ç¥¨ï¼š0050.TWã€0056.TWã€00878.TW ç­‰
â€¢ ç¾åœ‹è‚¡ç¥¨ï¼šVTIã€SPYã€QQQ ç­‰
â€¢ ä¹Ÿå¯ä»¥åªè¼¸å…¥æ•¸å­—ï¼š0050ã€0056 ç­‰

ğŸ’¡ è‚¡åƒ¹ä¾†æºï¼š
â€¢ å°ç£è‚¡ç¥¨ï¼šä½¿ç”¨å°ç£è­‰äº¤æ‰€å®˜æ–¹API
â€¢ åœ‹éš›è‚¡ç¥¨ï¼šä½¿ç”¨Yahoo Finance APIï¼Œè‡ªå‹•è½‰æ›ç‚ºå°å¹£é¡¯ç¤º
â€¢ å‚™ç”¨æ©Ÿåˆ¶ï¼šå¦‚æœä¸»è¦APIå¤±æ•—æœƒè‡ªå‹•åˆ‡æ›å‚™ç”¨ä¾†æº

ğŸ’± åŒ¯ç‡åŠŸèƒ½ï¼š
â€¢ ç¾è‚¡ETFåƒ¹æ ¼å’Œæˆæœ¬è‡ªå‹•è½‰æ›ç‚ºå°å¹£é¡¯ç¤º
â€¢ æ”¯æ´è‡ªå‹•æ›´æ–°åŒ¯ç‡æˆ–æ‰‹å‹•è¨­å®š
â€¢ é¡¯ç¤ºå°å¹£åƒ¹æ ¼/æˆæœ¬å’ŒåŸå§‹ç¾å…ƒåƒ¹æ ¼/æˆæœ¬
â€¢ åŒ¯ç‡è®Šå‹•æ™‚è‡ªå‹•é‡æ–°è¨ˆç®—æ‰€æœ‰ç¾è‚¡æ•¸æ“š

ğŸ¯ GKå‹•æ…‹æé ˜æ³•åŠŸèƒ½ï¼š
â€¢ è¨­å®šåˆå§‹æé ˜ç‡ï¼ˆå»ºè­°4%ï¼‰å’ŒæŠ•è³‡çµ„åˆèµ·å§‹åƒ¹å€¼
â€¢ è¨­å®šæœ€å¤§å¢æ¸›å¹…ï¼ˆå»ºè­°10%ï¼‰
â€¢ è¨˜éŒ„æ¯å¹´çš„å ±é…¬ç‡å’Œå¯¦éš›æé ˜é‡‘é¡
â€¢ ç³»çµ±æœƒæ ¹æ“šå‰ä¸€å¹´å ±é…¬ç‡è‡ªå‹•è¨ˆç®—å»ºè­°æé ˜é‡‘é¡

ğŸ“… GKæé ˜è¦å‰‡ï¼š
â€¢ æ­£å ±é…¬å¹´ï¼šå¯å¢åŠ æé ˜é‡‘é¡ï¼ˆä¸è¶…éæœ€å¤§å¢å¹…ï¼‰
â€¢ è² å ±é…¬å¹´ï¼šéœ€æ¸›å°‘æé ˜é‡‘é¡ï¼ˆä¸è¶…éæœ€å¤§æ¸›å¹…ï¼‰
â€¢ ç›®æ¨™ï¼šç¶­æŒé€€ä¼‘æœŸé–“çš„ç©©å®šç¾é‡‘æµ

ğŸ”„ è‡ªå‹•è¨ˆç®—ï¼š
â€¢ å¸‚å€¼ = ç›®å‰è‚¡åƒ¹ Ã— è‚¡æ•¸
â€¢ æœªå¯¦ç¾æç›Š = å¸‚å€¼ - ç¸½æˆæœ¬
â€¢ å ±é…¬ç‡ = æœªå¯¦ç¾æç›Š Ã· ç¸½æˆæœ¬ Ã— 100%
â€¢ ç•¶å¹´ç¸½è³‡ç”¢ = å¸‚å€¼ + ç•¶å¹´é ˜æ¯
â€¢ GKå»ºè­°æé ˜ = æ ¹æ“šå‰å¹´å ±é…¬ç‡å‹•æ…‹èª¿æ•´

ğŸ“ ä½¿ç”¨æµç¨‹ï¼š
1. æ–°å¢ETFä¸¦æ›´æ–°è‚¡åƒ¹
2. è¨­å®šGKæé ˜æ³•åƒæ•¸ä¸¦å•Ÿç”¨
3. æ¯å¹´è¨˜éŒ„å¹´åº¦å ±é…¬ç‡ï¼ˆå¯ä½¿ç”¨è‡ªå‹•è¨ˆç®—ï¼‰
4. åƒè€ƒç³»çµ±å»ºè­°çš„æé ˜é‡‘é¡é€²è¡Œæé ˜
5. å®šæœŸåŒ¯å‡ºå‚™ä»½è³‡æ–™

âš ï¸ æ³¨æ„äº‹é …ï¼š
â€¢ è‚¡åƒ¹è³‡æ–™å¯èƒ½æœ‰å»¶é²ï¼Œåƒ…ä¾›åƒè€ƒ
â€¢ GKæé ˜æ³•é©ç”¨æ–¼é€€ä¼‘éšæ®µçš„æŠ•è³‡çµ„åˆ
â€¢ å»ºè­°å®šæœŸå‚™ä»½è³‡æ–™ï¼ˆåŒ¯å‡ºåŠŸèƒ½ï¼‰
â€¢ å¹´åº¦å ±é…¬ç‡éœ€è¦æ‰‹å‹•è¨˜éŒ„ä»¥ç¢ºä¿æº–ç¢ºæ€§

å¿«æ·éµï¼šCtrl + Enter = æ–°å¢ETF
            `;
            alert(helpText);
        }

        // ==================== GKå‹•æ…‹æé ˜æ³•ç›¸é—œå‡½æ•¸ ====================

        // å•Ÿç”¨GKæé ˜æ³•
        function enableGK() {
            const initialRate = parseFloat(document.getElementById('initialRate').value);
            const startValue = parseFloat(document.getElementById('startValue').value);
            const maxIncrease = parseFloat(document.getElementById('maxIncrease').value) || 10;
            const maxDecrease = parseFloat(document.getElementById('maxDecrease').value) || 10;
            const inflationRate = parseFloat(document.getElementById('inflationRate').value) || 0;

            if (!initialRate || !startValue) {
                alert('è«‹å¡«å…¥åˆå§‹æé ˜ç‡å’ŒæŠ•è³‡çµ„åˆèµ·å§‹åƒ¹å€¼');
                return;
            }

            gkSettings = {
                initialWithdrawalRate: initialRate,
                currentWithdrawalAmount: startValue * (initialRate / 100),
                portfolioStartValue: startValue,
                maxIncrease: maxIncrease,
                maxDecrease: maxDecrease,
                inflationRate: inflationRate,
                enabled: true
            };

            saveGKSettings();
            updateGKDisplay();
            alert('GKæé ˜æ³•å·²å•Ÿç”¨ï¼');
        }

        // åœç”¨GKæé ˜æ³•
        function disableGK() {
            if (confirm('ç¢ºå®šè¦åœç”¨GKæé ˜æ³•å—ï¼Ÿ')) {
                gkSettings.enabled = false;
                saveGKSettings();
                updateGKDisplay();
            }
        }

        // æ›´æ–°GKè¨­å®š
        function updateGKSettings() {
            if (!gkSettings.enabled) {
                alert('è«‹å…ˆå•Ÿç”¨GKæé ˜æ³•');
                return;
            }

            const maxIncrease = parseFloat(document.getElementById('maxIncrease').value) || 10;
            const maxDecrease = parseFloat(document.getElementById('maxDecrease').value) || 10;

            gkSettings.maxIncrease = maxIncrease;
            gkSettings.maxDecrease = maxDecrease;

            saveGKSettings();
            updateGKDisplay();
            alert('GKè¨­å®šå·²æ›´æ–°ï¼');
        }

        // æ›´æ–°GKé¡¯ç¤º
        function updateGKDisplay() {
            // è¼‰å…¥è¨­å®šå€¼åˆ°è¼¸å…¥æ¡†
            document.getElementById('initialRate').value = gkSettings.initialWithdrawalRate || 6.0;
            document.getElementById('startValue').value = gkSettings.portfolioStartValue || 0;
            document.getElementById('maxIncrease').value = gkSettings.maxIncrease || 10;
            document.getElementById('maxDecrease').value = gkSettings.maxDecrease || 10;
            document.getElementById('inflationRate').value = gkSettings.inflationRate || 0; // æ–°å¢é€šè†¨ç‡é¡¯ç¤º

            // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
            document.getElementById('gkEnabled').textContent = gkSettings.enabled ? 'âœ… å·²å•Ÿç”¨' : 'âŒ æœªå•Ÿç”¨';
            document.getElementById('gkEnabled').className = `value ${gkSettings.enabled ? 'positive' : 'negative'}`;

            if (gkSettings.enabled) {
                const currentPortfolioValue = getCurrentPortfolioValue();
                const { amount: suggestedWithdrawal } = calculateGKWithdrawal(currentPortfolioValue);
                const currentRate = currentPortfolioValue > 0 ? (suggestedWithdrawal / currentPortfolioValue * 100) : 0;
                const rateDifference = currentRate - gkSettings.initialWithdrawalRate;

                document.getElementById('suggestedWithdrawal').textContent = `${suggestedWithdrawal.toLocaleString('zh-TW', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
                document.getElementById('currentRate').textContent = `${currentRate.toFixed(2)}%`;
                
                const diffElement = document.getElementById('rateDifference');
                diffElement.textContent = `${rateDifference >= 0 ? '+' : ''}${rateDifference.toFixed(2)}%`;
                diffElement.className = `value ${rateDifference >= 0 ? 'positive' : 'negative'}`;
            } else {
                document.getElementById('suggestedWithdrawal').textContent = '$0';
                document.getElementById('currentRate').textContent = '0%';
                document.getElementById('rateDifference').textContent = '0%';
            }
        }

        // è¨ˆç®—GKå»ºè­°æé ˜é‡‘é¡
        function calculateGKWithdrawal(currentValue) {
            if (!gkSettings.enabled) {
                return { amount: 0, rule: '' };
            }
            if (yearlyData.length === 0) {
                return { amount: gkSettings.currentWithdrawalAmount || 0, rule: 'åˆå§‹è¨­å®š' };
            }

            // å–å¾—æœ€è¿‘ä¸€å¹´çš„è³‡æ–™
            const lastYear = yearlyData[yearlyData.length - 1];
            const returnRate = lastYear.returnRate;
            const inflationRate = lastYear.inflationRate || 0; // å–å¾—é€šè†¨ç‡

            let newWithdrawalAmount = gkSettings.currentWithdrawalAmount;
            let triggeredRule = ''; // è¨˜éŒ„è§¸ç™¼çš„è¦å‰‡

            // 1. é€šè†¨è¦å‰‡
            if (returnRate >= 0) { // æ­£å ±é…¬å¹´æ‰é€²è¡Œé€šè†¨èª¿æ•´
                const adjustedInflationRate = Math.min(inflationRate, 6); // é€šè†¨èª¿æ•´ä¸Šé™6%
                newWithdrawalAmount = newWithdrawalAmount * (1 + adjustedInflationRate / 100);
                if (adjustedInflationRate > 0) {
                    triggeredRule = 'é€šè†¨';
                }
            } else {
                triggeredRule = 'å‡çµ'; // è² å ±é…¬å¹´å‡çµé€šè†¨èª¿æ•´
            }

            // 2. ä¿æœ¬è¦å‰‡ & 3. ç¹æ¦®è¦å‰‡
            const initialRate = gkSettings.initialWithdrawalRate / 100;
            const currentWithdrawalRate = newWithdrawalAmount / gkSettings.portfolioStartValue; // ä½¿ç”¨èµ·å§‹åƒ¹å€¼è¨ˆç®—æé ˜ç‡

            if (currentWithdrawalRate > initialRate * 1.2) { // é«˜å‡º20%ä»¥ä¸Šè§¸ç™¼ä¿æœ¬
                newWithdrawalAmount = newWithdrawalAmount * 0.9;
                triggeredRule = 'ä¿æœ¬';
            } else if (currentWithdrawalRate < initialRate * 0.8) { // ä½æ–¼20%ä»¥ä¸Šè§¸ç™¼ç¹æ¦®
                newWithdrawalAmount = newWithdrawalAmount * 1.1;
                triggeredRule = 'ç¹æ¦®';
            }

            // æ›´æ–°ç•¶å‰æé ˜é‡‘é¡
            gkSettings.currentWithdrawalAmount = newWithdrawalAmount;
            saveGKSettings();

            return { amount: newWithdrawalAmount, rule: triggeredRule }; // è¿”å›é‡‘é¡å’Œè§¸ç™¼è¦å‰‡
        }

        // å–å¾—ç›®å‰æŠ•è³‡çµ„åˆåƒ¹å€¼
        function getCurrentPortfolioValue() {
            let totalValue = 0;
            etfData.forEach(item => {
                totalValue += item.currentPrice * item.shares;
            });
            return totalValue;
        }

        // æ–°å¢å¹´åº¦è¨˜éŒ„
        function addYearlyRecord() {
            const year = parseInt(document.getElementById('recordYear').value);
            const returnRate = parseFloat(document.getElementById('yearReturn').value);
            const startValue = parseFloat(document.getElementById('yearStartValue').value);
            const endValue = parseFloat(document.getElementById('yearEndValue').value);
            const withdrawal = parseFloat(document.getElementById('yearWithdrawal').value) || 0;
            const inflationRate = parseFloat(document.getElementById('yearInflation').value) || 0; // å–å¾—é€šè†¨ç‡

            if (!year || isNaN(returnRate) || !startValue || !endValue) {
                alert('è«‹å¡«å…¥å®Œæ•´çš„å¹´åº¦è³‡æ–™');
                return;
            }

            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨è©²å¹´åº¦è¨˜éŒ„
            const existingIndex = yearlyData.findIndex(item => item.year === year);
            
            const { amount: suggestedWithdrawal, rule: triggeredRule } = calculateGKWithdrawalForYear(startValue, returnRate, inflationRate); // å‚³å…¥é€šè†¨ç‡

            const newRecord = {
                year: year,
                startValue: startValue,
                endValue: endValue,
                returnRate: returnRate,
                inflationRate: inflationRate, // ä¿å­˜é€šè†¨ç‡
                actualWithdrawal: withdrawal,
                suggestedWithdrawal: suggestedWithdrawal,
                withdrawalRate: startValue > 0 ? (withdrawal / startValue * 100) : 0,
                triggeredRule: triggeredRule // ä¿å­˜è§¸ç™¼è¦å‰‡
            };

            if (existingIndex !== -1) {
                if (confirm('è©²å¹´åº¦è¨˜éŒ„å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦æ›´æ–°ï¼Ÿ')) {
                    yearlyData[existingIndex] = newRecord;
                }
            } else {
                yearlyData.push(newRecord);
                yearlyData.sort((a, b) => a.year - b.year);
            }

            // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById('recordYear').value = '';
            document.getElementById('yearReturn').value = '';
            document.getElementById('yearStartValue').value = '';
            document.getElementById('yearEndValue').value = '';
            document.getElementById('yearWithdrawal').value = '';
            document.getElementById('yearInflation').value = ''; // æ¸…ç©ºé€šè†¨ç‡

            saveYearlyData();
            renderYearlyData();
            updateGKDisplay();
        }

        // è¨ˆç®—ç‰¹å®šå¹´åº¦çš„GKå»ºè­°æé ˜é‡‘é¡ (åŒ…å«é€šè†¨ã€ä¿æœ¬ã€ç¹æ¦®è¦å‰‡)
        function calculateGKWithdrawalForYear(startValue, returnRate, inflationRate) {
            if (!gkSettings.enabled) return { amount: 0, rule: '' };

            let baseWithdrawal = startValue * (gkSettings.initialWithdrawalRate / 100);
            let triggeredRule = '';

            // 1. é€šè†¨è¦å‰‡
            if (returnRate >= 0) { // æ­£å ±é…¬å¹´æ‰é€²è¡Œé€šè†¨èª¿æ•´
                const adjustedInflationRate = Math.min(inflationRate, 6); // é€šè†¨èª¿æ•´ä¸Šé™6%
                baseWithdrawal = baseWithdrawal * (1 + adjustedInflationRate / 100);
                if (adjustedInflationRate > 0) {
                    triggeredRule = 'é€šè†¨';
                }
            } else {
                triggeredRule = 'å‡çµ'; // è² å ±é…¬å¹´å‡çµé€šè†¨èª¿æ•´
            }

            // 2. ä¿æœ¬è¦å‰‡ & 3. ç¹æ¦®è¦å‰‡
            const initialRate = gkSettings.initialWithdrawalRate / 100;
            const currentWithdrawalRate = baseWithdrawal / startValue; // ä½¿ç”¨æœŸåˆè³‡ç”¢è¨ˆç®—æé ˜ç‡

            if (currentWithdrawalRate > initialRate * 1.2) { // é«˜å‡º20%ä»¥ä¸Šè§¸ç™¼ä¿æœ¬
                baseWithdrawal = baseWithdrawal * 0.9;
                triggeredRule = 'ä¿æœ¬';
            } else if (currentWithdrawalRate < initialRate * 0.8) { // ä½æ–¼20%ä»¥ä¸Šè§¸ç™¼ç¹æ¦®
                baseWithdrawal = baseWithdrawal * 1.1;
                triggeredRule = 'ç¹æ¦®';
            }

            return { amount: baseWithdrawal, rule: triggeredRule };
        }

        // è‡ªå‹•è¨ˆç®—æœ¬å¹´åº¦è³‡æ–™
        function autoCalculateCurrentYear() {
            const currentYear = new Date().getFullYear();
            const currentValue = getCurrentPortfolioValue();
            
            if (currentValue === 0) {
                alert('è«‹å…ˆæ–°å¢ETFä¸¦æ›´æ–°è‚¡åƒ¹');
                return;
            }

            // å°‹æ‰¾å»å¹´çš„è¨˜éŒ„ä½œç‚ºæœ¬å¹´å¹´åˆå€¼
            const lastYearRecord = yearlyData.find(record => record.year === currentYear - 1);
            const startValue = lastYearRecord ? lastYearRecord.endValue : currentValue;
            
            const returnRate = startValue > 0 ? ((currentValue - startValue) / startValue * 100) : 0;

            document.getElementById('recordYear').value = currentYear;
            document.getElementById('yearReturn').value = returnRate.toFixed(2);
            document.getElementById('yearStartValue').value = startValue.toFixed(0);
            document.getElementById('yearEndValue').value = currentValue.toFixed(0);

            alert(`å·²è‡ªå‹•è¨ˆç®—${currentYear}å¹´è³‡æ–™ï¼Œè«‹ç¢ºèªå¾Œæ–°å¢è¨˜éŒ„`);
        }

        // æ¸²æŸ“å¹´åº¦è³‡æ–™è¡¨æ ¼
        function renderYearlyData() {
            const tbody = document.getElementById('yearlyTableBody');
            tbody.innerHTML = '';

            yearlyData.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;"><strong>${record.year}</strong></td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">$${record.startValue.toLocaleString('zh-TW', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">$${record.endValue.toLocaleString('zh-TW', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;" class="${record.returnRate >= 0 ? 'positive' : 'negative'}">${record.returnRate.toFixed(2)}%</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${record.inflationRate.toFixed(2)}%</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">$${record.actualWithdrawal.toLocaleString('zh-TW', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: right;">$${record.suggestedWithdrawal.toLocaleString('zh-TW', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${record.withdrawalRate.toFixed(2)}%</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${record.triggeredRule || '--'}</td>
                    <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                        <button class="btn btn-danger" onclick="removeYearlyRecord(${index})" style="padding: 3px 8px; font-size: 12px;">åˆªé™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // åˆªé™¤å¹´åº¦è¨˜éŒ„
        function removeYearlyRecord(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†å¹´åº¦è¨˜éŒ„å—ï¼Ÿ')) {
                yearlyData.splice(index, 1);
                saveYearlyData();
                renderYearlyData();
                updateGKDisplay();
            }
        }

        // å„²å­˜GKè¨­å®š
        function saveGKSettings() {
            saveToLocalStorage();
        }

        // å„²å­˜å¹´åº¦è³‡æ–™
        function saveYearlyData() {
            saveToLocalStorage();
        }



        // ==================== åŒ¯ç‡ç›¸é—œå‡½æ•¸ ====================

        // æ›´æ–°åŒ¯ç‡é¡¯ç¤º
        function updateExchangeRateDisplay() {
            document.getElementById('usdRate').value = exchangeRate.usdToTwd;
            const updateText = exchangeRate.lastUpdate ? 
                `(æ›´æ–°: ${new Date(exchangeRate.lastUpdate).toLocaleString('zh-TW')})` : 
                '(æ‰‹å‹•è¨­å®š)';
            document.getElementById('rateUpdate').textContent = updateText;
        }

        // æ‰‹å‹•æ›´æ–°åŒ¯ç‡
        function updateManualExchangeRate() {
            const newRate = parseFloat(document.getElementById('usdRate').value);
            if (newRate && newRate > 0) {
                exchangeRate.usdToTwd = newRate;
                exchangeRate.lastUpdate = new Date().toISOString();
                saveExchangeRate();
                
                // é‡æ–°è¨ˆç®—æ‰€æœ‰ç¾è‚¡åƒ¹æ ¼å’Œæˆæœ¬
                etfData.forEach((item, index) => {
                    if (item.currency === 'USD') {
                        // é‡æ–°è¨ˆç®—åƒ¹æ ¼
                        if (item.originalPrice) {
                            item.currentPrice = Math.round(item.originalPrice * exchangeRate.usdToTwd * 100) / 100;
                        }
                        // é‡æ–°è¨ˆç®—æˆæœ¬
                        if (item.originalCost) {
                            item.cost = Math.round(item.originalCost * exchangeRate.usdToTwd * 100) / 100;
                        }
                    }
                });
                
                saveData();
                renderTable();
                updateSummary();
                updateExchangeRateDisplay();
            }
        }

        // è‡ªå‹•æ›´æ–°åŒ¯ç‡ (ä½¿ç”¨API)
        async function updateExchangeRate() {
            try {
                showLoading(true);
                
                // ä½¿ç”¨å¤šå€‹åŒ¯ç‡APIä½œç‚ºå‚™ç”¨
                let rate = null;
                
                // å˜—è©¦ç¬¬ä¸€å€‹API
                try {
                    const response1 = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                    const data1 = await response1.json();
                    if (data1.rates && data1.rates.TWD) {
                        rate = data1.rates.TWD;
                    }
                } catch (error) {
                    console.warn('ç¬¬ä¸€å€‹åŒ¯ç‡APIå¤±æ•—:', error);
                }
                
                // å¦‚æœç¬¬ä¸€å€‹å¤±æ•—ï¼Œå˜—è©¦ç¬¬äºŒå€‹API
                if (!rate) {
                    try {
                        const response2 = await fetch('https://api.fxratesapi.com/latest?base=USD&symbols=TWD');
                        const data2 = await response2.json();
                        if (data2.rates && data2.rates.TWD) {
                            rate = data2.rates.TWD;
                        }
                    } catch (error) {
                        console.warn('ç¬¬äºŒå€‹åŒ¯ç‡APIå¤±æ•—:', error);
                    }
                }
                
                if (rate && rate > 0) {
                    exchangeRate.usdToTwd = Math.round(rate * 100) / 100;
                    exchangeRate.lastUpdate = new Date().toISOString();
                    saveExchangeRate();
                    
                    // é‡æ–°è¨ˆç®—æ‰€æœ‰ç¾è‚¡åƒ¹æ ¼å’Œæˆæœ¬
                    etfData.forEach((item, index) => {
                        if (item.currency === 'USD') {
                            // é‡æ–°è¨ˆç®—åƒ¹æ ¼
                            if (item.originalPrice) {
                                item.currentPrice = Math.round(item.originalPrice * exchangeRate.usdToTwd * 100) / 100;
                            }
                            // é‡æ–°è¨ˆç®—æˆæœ¬
                            if (item.originalCost) {
                                item.cost = Math.round(item.originalCost * exchangeRate.usdToTwd * 100) / 100;
                            }
                        }
                    });
                    
                    saveData();
                    renderTable();
                    updateSummary();
                    updateExchangeRateDisplay();
                    
                    alert(`åŒ¯ç‡æ›´æ–°æˆåŠŸï¼USD/TWD = ${exchangeRate.usdToTwd}`);
                } else {
                    throw new Error('ç„¡æ³•å–å¾—åŒ¯ç‡è³‡æ–™');
                }
                
            } catch (error) {
                showError('åŒ¯ç‡æ›´æ–°å¤±æ•—: ' + error.message + 'ï¼Œè«‹æ‰‹å‹•è¼¸å…¥åŒ¯ç‡');
                console.error('åŒ¯ç‡æ›´æ–°éŒ¯èª¤:', error);
            } finally {
                showLoading(false);
            }
        }

        // å„²å­˜åŒ¯ç‡è³‡æ–™
        function saveExchangeRate() {
            saveToLocalStorage();
        }

        // æ›´æ–°åŒ¯å‡ºåŠŸèƒ½ä»¥åŒ…å«åŒ¯ç‡è³‡æ–™
        function exportData() {
            if (etfData.length === 0 && yearlyData.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º');
                return;
            }

            const exportData = {
                etfData: etfData,
                yearlyData: yearlyData,
                gkSettings: gkSettings,
                exchangeRate: exchangeRate,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `etf_gk_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        // æ›´æ–°åŒ¯å…¥åŠŸèƒ½ä»¥åŒ…å«åŒ¯ç‡è³‡æ–™
        function importData() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.etfData && Array.isArray(importedData.etfData)) {
                        etfData = importedData.etfData;
                    }
                    
                    if (importedData.yearlyData && Array.isArray(importedData.yearlyData)) {
                        yearlyData = importedData.yearlyData;
                    }
                    
                    if (importedData.gkSettings) {
                        gkSettings = importedData.gkSettings;
                    }
                    
                    if (importedData.exchangeRate) {
                        exchangeRate = importedData.exchangeRate;
                    }

                    saveData();
                    saveYearlyData();
                    saveGKSettings();
                    saveExchangeRate();
                    
                    renderTable();
                    updateSummary();
                    renderYearlyData();
                    updateGKDisplay();
                    updateExchangeRateDisplay();
                    
                    alert('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
                } catch (error) {
                    alert('æª”æ¡ˆè®€å–å¤±æ•—: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                addETF();
            }
        });

        // ==================== Supabase èªè­‰èˆ‡åŒæ­¥åŠŸèƒ½ ====================

        // æ™‚é–“æ ¼å¼è½‰æ›å‡½æ•¸
        function convertToISOString(dateString) {
            if (!dateString) return null;

            try {
                // å¦‚æœå·²ç¶“æ˜¯ ISO æ ¼å¼ï¼Œç›´æ¥è¿”å›
                if (dateString.includes('T') && dateString.includes('Z')) {
                    return dateString;
                }

                // è™•ç†ä¸­æ–‡æ™‚é–“æ ¼å¼ "2025/8/11 ä¸Šåˆ10:50:05"
                if (dateString.includes('ä¸Šåˆ') || dateString.includes('ä¸‹åˆ')) {
                    // æ›¿æ›ä¸­æ–‡æ™‚é–“æ¨™è¨˜
                    let cleanDate = dateString.replace('ä¸Šåˆ', 'AM').replace('ä¸‹åˆ', 'PM');

                    // è½‰æ›ç‚ºæ¨™æº–æ ¼å¼
                    const date = new Date(cleanDate);
                    if (!isNaN(date.getTime())) {
                        return date.toISOString();
                    }
                }

                // å˜—è©¦ç›´æ¥è§£æ
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return date.toISOString();
                }

                // å¦‚æœéƒ½å¤±æ•—ï¼Œè¿”å›ç•¶å‰æ™‚é–“
                return new Date().toISOString();
            } catch (error) {
                console.warn('æ™‚é–“æ ¼å¼è½‰æ›å¤±æ•—:', dateString, error);
                return new Date().toISOString();
            }
        }

        // å¾ ISO æ ¼å¼è½‰æ›å›ä¸­æ–‡æ™‚é–“æ ¼å¼
        function convertFromISOString(isoString) {
            if (!isoString) return null;

            try {
                const date = new Date(isoString);
                return date.toLocaleString('zh-TW');
            } catch (error) {
                console.warn('ISO æ™‚é–“æ ¼å¼è½‰æ›å¤±æ•—:', isoString, error);
                return isoString;
            }
        }

        // ç²å–ç•¶å‰æ™‚é–“çš„ä¸­æ–‡æ ¼å¼ï¼ˆç”¨æ–¼é¡¯ç¤ºï¼‰
        function getCurrentTimeString() {
            return new Date().toLocaleString('zh-TW');
        }

        // ä¿®å¾©ç¾æœ‰è³‡æ–™çš„ç¼ºå¤±æ¬„ä½
        function fixExistingData() {
            let dataFixed = false;

            etfData.forEach(item => {
                if (!item.name) {
                    item.name = item.symbol || 'Unknown';
                    dataFixed = true;
                }
                if (item.shares === undefined || item.shares === null) {
                    item.shares = 0;
                    dataFixed = true;
                }
                if (item.cost === undefined || item.cost === null) {
                    item.cost = 0;
                    dataFixed = true;
                }
                if (item.currentPrice === undefined || item.currentPrice === null) {
                    item.currentPrice = 0;
                    dataFixed = true;
                }
                if (item.dividend === undefined || item.dividend === null) {
                    item.dividend = 0;
                    dataFixed = true;
                }
            });

            if (dataFixed) {
                console.log('å·²ä¿®å¾©ç¾æœ‰è³‡æ–™çš„ç¼ºå¤±æ¬„ä½');
                localStorage.setItem('etfData', JSON.stringify(etfData));
            }
        }

        // æª¢æŸ¥ç”¨æˆ¶ç™»å…¥ç‹€æ…‹
        async function checkUserSession() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    console.log('ç”¨æˆ¶å·²ç™»å…¥:', currentUser.email);
                }
            } catch (error) {
                console.error('æª¢æŸ¥ç™»å…¥ç‹€æ…‹å¤±æ•—:', error);
            }
        }

        // ç”¨æˆ¶ç™»å…¥
        async function loginUser() {
            const email = prompt('è«‹è¼¸å…¥æ‚¨çš„ Emailï¼š');
            if (!email) return;

            try {
                const { error } = await supabase.auth.signInWithOtp({
                    email: email,
                    options: {
                        shouldCreateUser: true,
                        emailRedirectTo: 'https://demo.wscc1031.synology.me/etf-tracker/'
                    }
                });

                if (error) throw error;

                alert('å·²ç™¼é€ç™»å…¥é€£çµåˆ°æ‚¨çš„ Emailï¼Œè«‹æª¢æŸ¥ä¿¡ç®±ä¸¦é»æ“Šé€£çµå®Œæˆç™»å…¥ã€‚');
            } catch (error) {
                alert('ç™»å…¥å¤±æ•—: ' + error.message);
            }
        }

        // ç”¨æˆ¶ç™»å‡º
        async function logoutUser() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;

                currentUser = null;
                updateLoginStatus();
                alert('å·²æˆåŠŸç™»å‡º');
            } catch (error) {
                alert('ç™»å‡ºå¤±æ•—: ' + error.message);
            }
        }

        // æ›´æ–°ç™»å…¥ç‹€æ…‹é¡¯ç¤º
        function updateLoginStatus() {
            const statusElement = document.getElementById('loginStatus');
            if (statusElement) {
                if (currentUser) {
                    const autoSyncText = autoSyncEnabled ? 'è‡ªå‹•åŒæ­¥: é–‹å•Ÿ' : 'è‡ªå‹•åŒæ­¥: é—œé–‰';
                    const autoSyncClass = autoSyncEnabled ? 'positive' : 'negative';

                    statusElement.innerHTML = `
                        <div class="flex-wrap" style="align-items: center; margin-bottom: 0;">
                            <span class="positive">âœ“ å·²ç™»å…¥: ${currentUser.email}</span>
                            <span class="${autoSyncClass}" style="font-size: 12px;">${autoSyncText}</span>
                            <button class="btn" onclick="toggleAutoSync()" style="font-size: 12px; padding: 5px 10px; width: auto; margin: 0;">${autoSyncEnabled ? 'é—œé–‰' : 'é–‹å•Ÿ'}è‡ªå‹•åŒæ­¥</button>
                            <button class="btn" onclick="syncAllDataToCloud(true)" style="font-size: 12px; padding: 5px 10px; width: auto; margin: 0;">æ‰‹å‹•åŒæ­¥</button>
                            <button class="btn btn-danger" onclick="logoutUser()" style="font-size: 12px; padding: 5px 10px; width: auto; margin: 0;">ç™»å‡º</button>
                            <span id="syncStatus" class="text-small"></span>
                        </div>
                    `;
                } else {
                    statusElement.innerHTML = `
                        <div class="flex-wrap" style="align-items: center; margin-bottom: 0;">
                            <span class="negative">æœªç™»å…¥ (åƒ…æœ¬åœ°å„²å­˜)</span>
                            <button class="btn" onclick="loginUser()" style="font-size: 12px; padding: 5px 10px; width: auto; margin: 0;">ç™»å…¥</button>
                        </div>
                    `;
                }
            }
        }

        // åˆ‡æ›è‡ªå‹•åŒæ­¥
        function toggleAutoSync() {
            autoSyncEnabled = !autoSyncEnabled;
            localStorage.setItem('autoSyncEnabled', JSON.stringify(autoSyncEnabled));
            updateLoginStatus();

            if (autoSyncEnabled) {
                console.log('è‡ªå‹•åŒæ­¥å·²é–‹å•Ÿ');
            } else {
                console.log('è‡ªå‹•åŒæ­¥å·²é—œé–‰');
                // æ¸…é™¤å¾…åŸ·è¡Œçš„åŒæ­¥
                if (syncTimeout) {
                    clearTimeout(syncTimeout);
                    syncTimeout = null;
                }
            }
        }

        // ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN') {
                currentUser = session.user;
                console.log('ç”¨æˆ¶ç™»å…¥æˆåŠŸ:', currentUser.email);
                updateLoginStatus();
                // ç™»å…¥å¾Œè‡ªå‹•åŒæ­¥è³‡æ–™
                if (isOnline) {
                    loadDataFromCloud();
                }
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                updateLoginStatus();
            }
        });

        // å¾é›²ç«¯è¼‰å…¥è³‡æ–™
        async function loadDataFromCloud() {
            if (!currentUser || !isOnline || syncInProgress) return;

            syncInProgress = true;
            try {
                console.log('é–‹å§‹å¾é›²ç«¯è¼‰å…¥è³‡æ–™...');

                // è¼‰å…¥ ETF è³‡æ–™
                const { data: etfCloudData, error: etfError } = await supabase
                    .from('etf_data')
                    .select('*')
                    .eq('user_id', currentUser.id);

                if (etfError) throw etfError;

                // è¼‰å…¥å¹´åº¦è³‡æ–™
                const { data: yearlyCloudData, error: yearlyError } = await supabase
                    .from('yearly_data')
                    .select('*')
                    .eq('user_id', currentUser.id);

                if (yearlyError) throw yearlyError;

                // è¼‰å…¥ GK è¨­å®š
                const { data: gkCloudData, error: gkError } = await supabase
                    .from('gk_settings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                // GK è¨­å®šå¯èƒ½ä¸å­˜åœ¨ï¼Œæ‰€ä»¥ä¸æ‹‹å‡ºéŒ¯èª¤

                // è¼‰å…¥åŒ¯ç‡è³‡æ–™
                const { data: exchangeCloudData, error: exchangeError } = await supabase
                    .from('exchange_rates')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();

                // æ›´æ–°æœ¬åœ°è³‡æ–™
                if (etfCloudData && etfCloudData.length > 0) {
                    etfData = etfCloudData.map(item => ({
                        symbol: item.symbol || '',
                        name: item.name || item.symbol || 'Unknown',
                        shares: parseFloat(item.shares) || 0,
                        cost: parseFloat(item.cost) || 0,
                        currentPrice: parseFloat(item.current_price) || 0,
                        dividend: parseFloat(item.dividend) || 0,
                        lastUpdate: convertFromISOString(item.last_update),
                        originalPrice: parseFloat(item.original_price) || null,
                        currency: item.currency || 'TWD',
                        priceChange: parseFloat(item.price_change) || 0,
                        priceChangePercent: parseFloat(item.price_change_percent) || 0
                    }));
                    localStorage.setItem('etfData', JSON.stringify(etfData));
                }

                if (yearlyCloudData && yearlyCloudData.length > 0) {
                    yearlyData = yearlyCloudData.map(item => ({
                        year: item.year,
                        ...item.data
                    }));
                    localStorage.setItem('yearlyData', JSON.stringify(yearlyData));
                }

                if (gkCloudData && !gkError) {
                    gkSettings = {
                        initialWithdrawalRate: parseFloat(gkCloudData.initial_rate) || 4.0,
                        currentWithdrawalAmount: parseFloat(gkCloudData.total_withdrawn) || 0,
                        portfolioStartValue: parseFloat(gkCloudData.start_value) || 0,
                        enabled: gkCloudData.is_enabled || false,
                        ...gkCloudData.settings
                    };
                    localStorage.setItem('gkSettings', JSON.stringify(gkSettings));
                }

                if (exchangeCloudData && !exchangeError) {
                    exchangeRate = {
                        usdToTwd: parseFloat(exchangeCloudData.usd_to_twd) || 31.5,
                        lastUpdate: convertFromISOString(exchangeCloudData.last_update)
                    };
                    localStorage.setItem('exchangeRate', JSON.stringify(exchangeRate));
                }

                console.log('é›²ç«¯è³‡æ–™è¼‰å…¥å®Œæˆ');

                // é‡æ–°æ¸²æŸ“é é¢
                renderTable();
                updateSummary();
                renderYearlyData();
                updateGKDisplay();
                updateExchangeRateDisplay();

            } catch (error) {
                console.error('è¼‰å…¥é›²ç«¯è³‡æ–™å¤±æ•—:', error);
            } finally {
                syncInProgress = false;
            }
        }

        // åŒæ­¥æ‰€æœ‰è³‡æ–™åˆ°é›²ç«¯
        async function syncAllDataToCloud(showAlert = false) {
            if (!currentUser || !isOnline || syncInProgress) return;

            syncInProgress = true;
            try {
                console.log('é–‹å§‹åŒæ­¥è³‡æ–™åˆ°é›²ç«¯...');

                // åŒæ­¥ ETF è³‡æ–™
                await syncETFDataToCloud();

                // åŒæ­¥å¹´åº¦è³‡æ–™
                await syncYearlyDataToCloud();

                // åŒæ­¥ GK è¨­å®š
                await syncGKSettingsToCloud();

                // åŒæ­¥åŒ¯ç‡è³‡æ–™
                await syncExchangeRateToCloud();

                lastSyncTime = Date.now();
                console.log('æ‰€æœ‰è³‡æ–™åŒæ­¥å®Œæˆ');

                // åªæœ‰æ‰‹å‹•åŒæ­¥æ™‚æ‰é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                if (showAlert) {
                    alert('è³‡æ–™åŒæ­¥æˆåŠŸï¼');
                }

                // æ›´æ–°åŒæ­¥ç‹€æ…‹é¡¯ç¤º
                updateSyncStatus('å·²åŒæ­¥');

            } catch (error) {
                console.error('åŒæ­¥è³‡æ–™å¤±æ•—:', error);
                updateSyncStatus('åŒæ­¥å¤±æ•—');

                // éŒ¯èª¤è¨Šæ¯ç¸½æ˜¯é¡¯ç¤º
                alert('åŒæ­¥å¤±æ•—: ' + error.message);
            } finally {
                syncInProgress = false;
                syncQueue = false;
            }
        }

        // åŒæ­¥ ETF è³‡æ–™åˆ°é›²ç«¯
        async function syncETFDataToCloud() {
            if (!currentUser) return;

            // å…ˆåˆªé™¤ç¾æœ‰è³‡æ–™
            await supabase
                .from('etf_data')
                .delete()
                .eq('user_id', currentUser.id);

            // æ’å…¥æ–°è³‡æ–™
            if (etfData.length > 0) {
                const cloudData = etfData.map(item => ({
                    user_id: currentUser.id,
                    symbol: item.symbol || '',
                    name: item.name || item.symbol || 'Unknown',
                    shares: item.shares || 0,
                    cost: item.cost || 0,
                    current_price: item.currentPrice || 0,
                    dividend: item.dividend || 0,
                    last_update: convertToISOString(item.lastUpdate),
                    original_price: item.originalPrice,
                    currency: item.currency || 'TWD',
                    price_change: item.priceChange || 0,
                    price_change_percent: item.priceChangePercent || 0
                }));

                const { error } = await supabase
                    .from('etf_data')
                    .insert(cloudData);

                if (error) throw error;
            }
        }

        // åŒæ­¥å¹´åº¦è³‡æ–™åˆ°é›²ç«¯
        async function syncYearlyDataToCloud() {
            if (!currentUser) return;

            // å…ˆåˆªé™¤ç¾æœ‰è³‡æ–™
            await supabase
                .from('yearly_data')
                .delete()
                .eq('user_id', currentUser.id);

            // æ’å…¥æ–°è³‡æ–™
            if (yearlyData.length > 0) {
                const cloudData = yearlyData.map(item => ({
                    user_id: currentUser.id,
                    year: item.year,
                    data: {
                        totalValue: item.totalValue,
                        totalCost: item.totalCost,
                        totalDividend: item.totalDividend,
                        totalPnL: item.totalPnL,
                        returnRate: item.returnRate,
                        gkWithdrawal: item.gkWithdrawal || 0
                    }
                }));

                const { error } = await supabase
                    .from('yearly_data')
                    .insert(cloudData);

                if (error) throw error;
            }
        }

        // åŒæ­¥ GK è¨­å®šåˆ°é›²ç«¯
        async function syncGKSettingsToCloud() {
            if (!currentUser) return;

            // å…ˆåˆªé™¤ç¾æœ‰è¨­å®š
            await supabase
                .from('gk_settings')
                .delete()
                .eq('user_id', currentUser.id);

            // æ’å…¥æ–°è¨­å®š
            const cloudData = {
                user_id: currentUser.id,
                is_enabled: gkSettings.enabled || false,
                initial_rate: gkSettings.initialWithdrawalRate || 4.0,
                start_value: gkSettings.portfolioStartValue || 0,
                current_rate: gkSettings.initialWithdrawalRate || 4.0,
                total_withdrawn: gkSettings.currentWithdrawalAmount || 0,
                settings: {
                    maxIncrease: gkSettings.maxIncrease || 10,
                    maxDecrease: gkSettings.maxDecrease || 10
                }
            };

            const { error } = await supabase
                .from('gk_settings')
                .insert([cloudData]);

            if (error) throw error;
        }

        // åŒæ­¥åŒ¯ç‡è³‡æ–™åˆ°é›²ç«¯
        async function syncExchangeRateToCloud() {
            if (!currentUser) return;

            // åŒ¯ç‡è³‡æ–™æ˜¯å…¨åŸŸçš„ï¼Œç›´æ¥æ›´æ–°æœ€æ–°è¨˜éŒ„
            const { error } = await supabase
                .from('exchange_rates')
                .insert({
                    usd_to_twd: exchangeRate.usdToTwd || 31.5,
                    last_update: convertToISOString(exchangeRate.lastUpdate) || new Date().toISOString()
                });

            if (error) throw error;
        }

        // é˜²æŠ–åŒæ­¥å‡½æ•¸
        let syncTimeout = null;
        function debouncedSync() {
            if (!currentUser || !isOnline || !autoSyncEnabled) return;

            // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
            if (syncTimeout) {
                clearTimeout(syncTimeout);
            }

            // è¨­å®šæ–°çš„è¨ˆæ™‚å™¨ï¼Œ2ç§’å¾ŒåŸ·è¡ŒåŒæ­¥
            syncTimeout = setTimeout(() => {
                if (!syncInProgress) {
                    syncQueue = true;
                    updateSyncStatus('åŒæ­¥ä¸­...');
                    syncAllDataToCloud(false); // è‡ªå‹•åŒæ­¥ä¸é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                }
            }, 2000);

            updateSyncStatus('ç­‰å¾…åŒæ­¥...');
        }

        // æ›´æ–°åŒæ­¥ç‹€æ…‹é¡¯ç¤º
        function updateSyncStatus(status) {
            const statusElement = document.getElementById('syncStatus');
            if (statusElement) {
                const now = new Date().toLocaleTimeString('zh-TW');
                statusElement.textContent = `${status} (${now})`;

                // 3ç§’å¾Œæ¸…é™¤ç‹€æ…‹
                setTimeout(() => {
                    if (statusElement.textContent.includes(status)) {
                        statusElement.textContent = '';
                    }
                }, 3000);
            }
        }

        // ä¿®æ”¹åŸæœ‰çš„å„²å­˜å‡½æ•¸ï¼ŒåŠ å…¥é˜²æŠ–åŒæ­¥
        function saveToLocalStorage() {
            localStorage.setItem('etfData', JSON.stringify(etfData));
            localStorage.setItem('yearlyData', JSON.stringify(yearlyData));
            localStorage.setItem('gkSettings', JSON.stringify(gkSettings));
            localStorage.setItem('exchangeRate', JSON.stringify(exchangeRate));

            // ä½¿ç”¨é˜²æŠ–åŒæ­¥
            debouncedSync();
        }
    </script>
</body>
</html>
